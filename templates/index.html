<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ .Title }}</title>
    <meta http-equiv="X-UA-Compatible" content="IE=7">
    <meta name="description"
        content="Host and manage your SQLite databases in the cloud with unparalleled speed and simplicity">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="keywords" content="SQLite, SQL, databases, cloud, hosting, edge computing">
    <link rel="shortcut icon" href="/static/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="/static/style.css">
    <link rel="apple-touch-icon" href="/static/favicon.png">
    <script defer src="/static/tailwindcss.js"></script>
    <script defer src="/static/alpine.js"></script>
    <script defer src="/static/themeManager.js"></script>
</head>

<body x-data="sqlitePanel()" x-init="init()">
    <!-- loading Screen -->
    <template x-if="screenLoading">
        <div class="screen-loading-overlay">
            <div class="spinner"></div>
        </div>
    </template>

    <!-- Theme Selector UI -->
    <div style="position: fixed; top: 12px; right: 12px; z-index: 100;">
        <div class="theme-controls">
            <select class="theme-selector" id="themeSelector">
                <option value="auto">üåì Auto (System)</option>
                <option value="dark">üåô Dark</option>
                <option value="light">‚òÄÔ∏è Light</option>
            </select>
            <div class="theme-status" id="themeStatus">
                <span class="theme-icon">üåì</span>
                <span id="currentTheme">Auto</span>
            </div>
        </div>
        <div style="font-size: 11px; color: #aaa; margin-top: 2px;">
            <span id="activeTheme">Auto (dark mode active)</span> | System: <span id="systemPreference">Dark</span>
        </div>
    </div>


    <!-- Authentication Screen -->
    <template x-if="!isAuthenticated && !sharedDb">
        <div class="auth-container">
            <div class="card">
                <div class="header">
                    <h1>
                        <i data-lucide="database"></i>
                        VileSQL
                    </h1>
                </div>

                <div style="padding: 20px;">
                    <div x-show="message.text" class="alert"
                        :class="message.type === 'error' ? 'alert-error' : 'alert-success'">
                        <span x-text="message.text"></span>
                    </div>

                    <div class="tab-nav">
                        <button class="tab-btn" :class="authMode === 'login' ? 'active' : ''"
                            @click="authMode = 'login'">
                            Login
                        </button>
                        <button class="tab-btn" :class="authMode === 'register' ? 'active' : ''"
                            @click="authMode = 'register'">
                            Register
                        </button>
                    </div>

                    <form @submit.prevent="authMode === 'login' ? login() : register()" style="padding: 20px 0;">
                        <template x-if="authMode === 'login'">
                            <div>
                                <div class="form-group">
                                    <label>Username</label>
                                    <input type="text" class="form-control" x-model="authFormLogin.username" required>
                                </div>
                                <div class="form-group">
                                    <label>Password</label>
                                    <input type="password" class="form-control" x-model="authFormLogin.password"
                                        required>
                                </div>
                            </div>
                        </template>
                        <template x-if="authMode === 'register'">
                            <div>
                                <div class="form-group">
                                    <label>Username</label>
                                    <input type="text" class="form-control" x-model="authFormRegister.username"
                                        required>
                                </div>
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email" class="form-control" x-model="authFormRegister.email" required>
                                </div>
                                <div class="form-group">
                                    <label>Password</label>
                                    <input type="password" class="form-control" x-model="authFormRegister.password"
                                        required>
                                </div>
                            </div>
                        </template>
                        <button type="submit" class="btn btn-primary" style="width: 100%;" :disabled="loading">
                            <template x-if="loading">
                                <div class="spinner" style="width: 16px; height: 16px;"></div>
                            </template>
                            <span
                                x-text="loading ? 'Processing...' : (authMode === 'login' ? 'Login' : 'Register')"></span>
                        </button>
                    </form>

                    <div style="border-top: 1px solid #444; padding-top: 16px;">
                        <div class="section-header">Access Shared Database</div>
                        <div class="flex gap-2">
                            <input type="text" class="form-control" x-model="sharedToken"
                                placeholder="Enter share token">
                            <button class="btn btn-secondary" @click="accessSharedDatabase()" :disabled="!sharedToken">
                                <i data-lucide="share-2"></i>
                                Access
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- Main Application -->
    <template x-if="isAuthenticated || sharedDb">
        <div class="container">
            <div class="card">
                <div class="header">
                    <h1>
                        <!-- database icon -->
                        <svg width="26" height="26" viewBox="0 0 20 20" fill="none" style="flex-shrink:0;"
                            xmlns="http://www.w3.org/2000/svg">
                            <ellipse cx="10" cy="5" rx="8" ry="3" fill="#ec4899" />
                            <ellipse cx="10" cy="10" rx="8" ry="3" fill="#ec4899" fill-opacity="0.8" />
                            <ellipse cx="10" cy="15" rx="8" ry="3" fill="#ec4899" fill-opacity="0.6" />
                        </svg>
                        <span x-text="sharedDb ? `Shared: ${sharedDb.name}` : 'VileSQL Database Manager'"></span>
                    </h1>
                </div>

                <div x-show="message.text" class="alert"
                    :class="message.type === 'error' ? 'alert-error' : 'alert-success'" style="margin: 12px;">
                    <span x-text="message.text"></span>
                </div>

                <div class="main-layout">
                    <!-- Sidebar -->
                    <div class="sidebar">
                        <div>
                            <div class="database-list">
                                <div class="section-header">
                                    Databases
                                    <button title="Shows all databases" class="cursor-pointer" @click="selectedDb=null">
                                        Reload Databases
                                    </button>
                                </div>
                                <div class="section-body">
                                    <template x-if="sharedDb">
                                        <div x-show="selectedDb?selectedDb.name===sharedDb.name:true" class="database-item active" @click="selectDatabase(sharedDb)">
                                            <div style="font-weight: 500;" x-text="sharedDb.name"></div>
                                            <div style="font-size: 10px; color: #888;">Shared Database</div>
                                        </div>
                                    </template>

                                    <template x-if="isAuthenticated">
                                        <div>
                                            <div x-show="databases.length === 0"
                                                class="text-[#888] text-[11px] flex items-center justify-center h-[80px]">
                                                No databases found
                                            </div>

                                            <template x-for="db in databases" :key="db.id">
                                                <div x-show="selectedDb?selectedDb.name===db.name:true" class="database-item"
                                                    :class="selectedDb && selectedDb.id === db.id ? 'active' : ''"
                                                    @click="selectDatabase(db)"
                                                >
                                                    <div
                                                        style="display: flex; align-items: center; gap: 8px; font-weight: 500;">
                                                        <!-- Pink SQL Database SVG Icon -->
                                                        <svg width="18" height="18" viewBox="0 0 20 20" fill="none"
                                                            style="flex-shrink:0;" xmlns="http://www.w3.org/2000/svg">
                                                            <ellipse cx="10" cy="5" rx="8" ry="3" fill="#ec4899" />
                                                            <ellipse cx="10" cy="10" rx="8" ry="3" fill="#ec4899"
                                                                fill-opacity="0.8" />
                                                            <ellipse cx="10" cy="15" rx="8" ry="3" fill="#ec4899"
                                                                fill-opacity="0.6" />
                                                        </svg>
                                                        <span x-text="db.name"></span>
                                                    </div>
                                                    <div style="font-size: 10px; color: #888; margin-top: 2px;">
                                                        <span
                                                            x-text="new Date(db.created_at).toLocaleDateString()"></span>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </template>
                                </div>
                            </div>

                            <!-- Tables Section -->
                            <div x-show="selectedDb && tables.length > 0" class="tables-section flex-grow">
                                <div class="section-header">Tables</div>
                                <div class="section-body">
                                    <template x-for="table in tables" :key="table">
                                        <div class="table-item" :class="selectedTable === table ? 'active' : ''"
                                            @click="selectTable(table)">
                                            <!-- Table SVG Icon -->
                                            <svg class="table-icon" width="12" height="12" viewBox="0 0 16 16"
                                                fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <rect x="1" y="2" width="14" height="12" rx="2" fill="#60a5fa" />
                                                <rect x="1" y="5" width="14" height="1" fill="#2563eb" />
                                                <rect x="1" y="8" width="14" height="1" fill="#2563eb" />
                                                <rect x="1" y="11" width="14" height="1" fill="#2563eb" />
                                            </svg>
                                            <span x-text="table"></span>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>

                        <div x-show="isAuthenticated" class="user-info">
                            <div class="flex flex-col gap-2 w-full">
                                <button class="btn btn-primary" style="width: 100%;"
                                    @click="showCreateModal = true">
                                    <!-- plus icon -->
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none"
                                        style="vertical-align: middle;" xmlns="http://www.w3.org/2000/svg">
                                        <rect x="7" y="2" width="2" height="12" rx="1" fill="#fff" />
                                        <rect x="2" y="7" width="12" height="2" rx="1" fill="#fff" />
                                    </svg>
                                    New Database
                                </button>
                                <div class="flex items-center justify-center gap-2">
                                    <span x-show="isAuthenticated" style="margin-right: 16px; font-size: 12px;">
                                        Welcome, <span x-text="user"></span>
                                    </span>
                                    <button x-show="isAuthenticated" class="btn btn-secondary" @click="logout()">
                                        <!-- logout icon -->
                                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none"
                                            style="vertical-align: middle;" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M6 2H3.5A1.5 1.5 0 0 0 2 3.5v9A1.5 1.5 0 0 0 3.5 14H6"
                                                stroke="#fff" stroke-width="1.5" stroke-linecap="round" />
                                            <path d="M10.5 11L14 8m0 0l-3.5-3M14 8H6" stroke="#fff" stroke-width="1.5"
                                                stroke-linecap="round" stroke-linejoin="round" />
                                        </svg>
                                        Logout
                                    </button>
                                    <button x-show="sharedDb && !isAuthenticated" class="btn btn-secondary"
                                        @click="sharedDb = null; sharedToken = ''">
                                        <!-- close icon -->
                                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none"
                                            style="vertical-align: middle;" xmlns="http://www.w3.org/2000/svg">
                                            <line x1="4" y1="4" x2="12" y2="12" stroke="#fff" stroke-width="2" />
                                            <line x1="12" y1="4" x2="4" y2="12" stroke="#fff" stroke-width="2" />
                                        </svg>
                                        Close
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Content Area -->
                    <div class="content-area" style="position: relative;">
                        <template x-if="loading">
                            <div class="loading-overlay">
                                <div class="spinner"></div>
                            </div>
                        </template>

                        <!-- Toolbar -->
                        <div class="toolbar">
                            <template x-if="selectedDb">
                                <div class="flex gap-2 w-full">
                                    <template x-if="!selectedTable">
                                        <button class="btn btn-primary" @click="showTableModal = true">
                                            <!-- Table SVG Icon -->
                                            <svg class="table-icon" width="12" height="12" viewBox="0 0 16 16"
                                                fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <rect x="1" y="2" width="14" height="12" rx="2" fill="#60a5fa" />
                                                <rect x="1" y="5" width="14" height="1" fill="#2563eb" />
                                                <rect x="1" y="8" width="14" height="1" fill="#2563eb" />
                                                <rect x="1" y="11" width="14" height="1" fill="#2563eb" />
                                            </svg>
                                            New Table
                                        </button>
                                    </template>
                                    <template x-if="selectedTable">
                                        <button class="btn btn-success" @click="showInsertModal = true">
                                            <!-- plus icon -->
                                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"
                                                style="vertical-align: middle;" xmlns="http://www.w3.org/2000/svg">
                                                <rect x="7" y="2" width="2" height="12" rx="1" fill="#fff" />
                                                <rect x="2" y="7" width="12" height="2" rx="1" fill="#fff" />
                                            </svg>
                                            Insert Data
                                        </button>
                                    </template>

                                    <template x-if="selectedTable">
                                        <button type="button" class="btn btn-secondary"
                                            @click="selectTable(selectedTable)">
                                            Reload Table
                                        </button>
                                    </template>

                                    <template x-if="isAuthenticated && selectedDb&& !selectedTable">
                                        <button class="btn btn-secondary" @click="shareDatabase(selectedDb)">
                                            <!-- lock icon -->
                                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"
                                                style="vertical-align: middle;" xmlns="http://www.w3.org/2000/svg"
                                                x-show="!selectedDb.is_shared">
                                                <rect x="3" y="7" width="10" height="7" rx="2" fill="#fff"
                                                    fill-opacity="0.15" />
                                                <rect x="3" y="7" width="10" height="7" rx="2" stroke="#fff"
                                                    stroke-width="1" />
                                                <rect x="7" y="10" width="2" height="3" rx="1" fill="#fff" />
                                                <path d="M5 7V5a3 3 0 1 1 6 0v2" stroke="#fff" stroke-width="1"
                                                    fill="none" />
                                            </svg>
                                            <!-- unlock icon -->
                                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"
                                                style="vertical-align: middle;" xmlns="http://www.w3.org/2000/svg"
                                                x-show="selectedDb.is_shared">
                                                <rect x="3" y="7" width="10" height="7" rx="2" fill="#fff"
                                                    fill-opacity="0.15" />
                                                <rect x="3" y="7" width="10" height="7" rx="2" stroke="#fff"
                                                    stroke-width="1" />
                                                <rect x="7" y="10" width="2" height="3" rx="1" fill="#fff" />
                                                <path d="M8 7V5a3 3 0 0 1 6 0" stroke="#fff" stroke-width="1"
                                                    fill="none" />
                                                <circle cx="12" cy="5" r="1" fill="#fff" />
                                            </svg>
                                            <span x-text="selectedDb.is_shared ? 'Unshare' : 'Share'"></span>
                                        </button>
                                    </template>

                                    <template x-if="isAuthenticated && selectedTable">
                                        <button class="btn btn-danger" style="margin-left: auto;"
                                            @click="showDeleteTableModal=true">
                                            <!-- trash icon -->
                                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"
                                                style="vertical-align: middle;" xmlns="http://www.w3.org/2000/svg">
                                                <rect x="3" y="6" width="10" height="7" rx="2" fill="#fff"
                                                    fill-opacity="0.15" />
                                                <rect x="3" y="6" width="10" height="7" rx="2" stroke="#fff"
                                                    stroke-width="1" />
                                                <rect x="7" y="9" width="2" height="3" rx="1" fill="#fff" />
                                                <rect x="5" y="3" width="6" height="2" rx="1" fill="#fff" />
                                                <rect x="6" y="2" width="4" height="1" rx="0.5" fill="#fff"
                                                    fill-opacity="0.5" />
                                                <rect x="2" y="5" width="12" height="1" fill="#fff" />
                                                <line x1="6" y1="8" x2="10" y2="12" stroke="#d83b01"
                                                    stroke-width="1.5" />
                                                <line x1="10" y1="8" x2="6" y2="12" stroke="#d83b01"
                                                    stroke-width="1.5" />
                                            </svg>
                                            Delete Table
                                        </button>
                                    </template>

                                    <template x-if="isAuthenticated && selectedDb && !selectedTable">
                                        <button class="btn btn-danger" style="margin-left: auto;"
                                            @click="showDeleteModal = true">
                                            <!-- trash icon -->
                                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"
                                                style="vertical-align: middle;" xmlns="http://www.w3.org/2000/svg">
                                                <rect x="3" y="6" width="10" height="7" rx="2" fill="#fff"
                                                    fill-opacity="0.15" />
                                                <rect x="3" y="6" width="10" height="7" rx="2" stroke="#fff"
                                                    stroke-width="1" />
                                                <rect x="7" y="9" width="2" height="3" rx="1" fill="#fff" />
                                                <rect x="5" y="3" width="6" height="2" rx="1" fill="#fff" />
                                                <rect x="6" y="2" width="4" height="1" rx="0.5" fill="#fff"
                                                    fill-opacity="0.5" />
                                                <rect x="2" y="5" width="12" height="1" fill="#fff" />
                                                <line x1="6" y1="8" x2="10" y2="12" stroke="#d83b01"
                                                    stroke-width="1.5" />
                                                <line x1="10" y1="8" x2="6" y2="12" stroke="#d83b01"
                                                    stroke-width="1.5" />
                                            </svg>
                                            Delete DB
                                        </button>
                                    </template>
                                </div>
                            </template>
                        </div>

                        <!-- Filter Bar -->
                        <div x-show="selectedTable && tableData.length > 0" class="filter-bar">
                            <label>Filter:</label>
                            <input type="text" class="filter-input" x-model="filterText"
                                placeholder="Search in table...">
                            <span style="margin-left: auto; color: #888;"
                                x-text="`${filteredTableData.length} rows`"></span>
                        </div>


                        <!-- Data Table -->
                        <div class="data-table-container">
                            <template x-if="!selectedDb">
                                <div class="empty-state">
                                    <!-- database icon -->
                                    <svg width="48" height="48" viewBox="0 0 20 20" fill="none" style="flex-shrink:0;"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <ellipse cx="10" cy="5" rx="8" ry="3" fill="#ec4899" />
                                        <ellipse cx="10" cy="10" rx="8" ry="3" fill="#ec4899" fill-opacity="0.8" />
                                        <ellipse cx="10" cy="15" rx="8" ry="3" fill="#ec4899" fill-opacity="0.6" />
                                    </svg>
                                    <h3>Select a database to get started</h3>
                                    <p>Choose a database from the sidebar to explore its contents</p>
                                </div>
                            </template>

                            <template x-if="selectedDb && !selectedTable">
                                <div class="empty-state">
                                    <!-- table icon -->
                                    <svg width="48" height="48" viewBox="0 0 16 16" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <rect x="1" y="2" width="14" height="12" rx="2" fill="#60a5fa" />
                                        <rect x="1" y="5" width="14" height="1" fill="#2563eb" />
                                        <rect x="1" y="8" width="14" height="1" fill="#2563eb" />
                                        <rect x="1" y="11" width="14" height="1" fill="#2563eb" />
                                    </svg>
                                    <h3>Select a table to view data</h3>
                                    <p>Choose a table from the sidebar or create a new one</p>
                                </div>
                            </template>

                            <template x-if="selectedTable && tableColumns.length > 0">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th class="row-number">#</th>
                                            <template x-for="column in tableColumns" :key="column.name">
                                                <th style="min-width: 300px;">
                                                    <div class="flex justify-between items-center">
                                                        <span x-text="column.name"></span>
                                                        <template x-if="column.constraint">
                                                            <span class="text-[10px] text-[#60a5fa] mr-2 ml-auto">
                                                                <span x-text="column.constraint.type"></span>
                                                                <span
                                                                    x-text="column.constraint.unique?'UNIQUE':''"></span>
                                                                <span
                                                                    x-text="column.constraint.primary_key?'PRIMARY':''"></span>
                                                                <span
                                                                    x-text="column.constraint.not_null?'NOT NULL':''"></span>
                                                            </span>
                                                        </template>
                                                    </div>
                                                </th>
                                            </template>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Data rows -->
                                        <template x-for="(row, index) in filteredTableData" :key="index">
                                            <tr>
                                                <td class="row-number cursor-pointer" x-text="selectShowDeleteRowIcon ? 'üóëÔ∏è' : index + 1"
                                                    @mouseover="selectShowDeleteRowIcon = true"
                                                    @mouseenter="selectShowDeleteRowIcon = true"
                                                    @mouseleave="selectShowDeleteRowIcon = false"
                                                    @click="showRowDropdown = { row: row, index: index }">
                                                </td>

                                                <template x-for="(column, colIndex) in tableColumns" :key="column.name">
                                                    <td style="min-width: 300px;" @dblclick="
                                                            if (!editingCell || editingCell.row !== index || editingCell.col !== column.name) {
                                                                editingCell = { row: index, col: column.name, value: Array.isArray(row) ? row[colIndex] : row[column.name] }
                                                            }
                                                        ">
                                                        <template
                                                            x-if="editingCell && editingCell.row === index && editingCell.col === column.name">
                                                            <input type="text" class="form-control text-[11px]"
                                                                x-model="editingCell.value" @keydown.enter.stop.prevent="
                                                                    updateCell(index, column.name, editingCell.value, row[colIndex]);
                                                                    editingCell = null;
                                                                " @keydown.esc="editingCell = null"
                                                                @blur="editingCell = null"
                                                                style="padding:2px 6px; min-width: 60px;" autofocus>
                                                        </template>
                                                        <template
                                                            x-if="!editingCell || editingCell.row !== index || editingCell.col !== column.name">
                                                            <span
                                                                x-text="Array.isArray(row) ? (row[colIndex] !== null ? row[colIndex] : 'NULL') : (row[column.name] !== null ? row[column.name] : 'NULL')"
                                                                :title="Array.isArray(row) ? row[colIndex] : row[column.name]"></span>
                                                        </template>
                                                    </td>
                                                </template>
                                            </tr>
                                        </template>
                                        <!-- Extra row for adding data -->
                                        <tr>
                                            <td class="row-number">+</td>
                                            <template x-for="(column, colIndex) in tableColumns" :key="column.name">
                                                <td style="min-width: 300px;">
                                                    <input type="text" class="form-control text-[11px]"
                                                        :placeholder="column.name" x-model="insertRow[column.name]"
                                                        @keydown.enter.stop.prevent="addRow()" style="padding:2px 6px;">
                                                </td>
                                            </template>
                                        </tr>
                                    </tbody>
                                </table>
                            </template>
                        </div>

                        <!-- Query Panel -->
                        <div x-show="selectedDb" class="query-panel">
                            <div class="form-group">
                                <label>SQL Query</label>
                                <textarea class="query-editor" x-model="queryText" :placeholder="selectedTable && tableColumns.length > 0
                                        ? `INSERT INTO ${selectedTable} (${tableColumns.map(col => col.name).join(', ')}) VALUES (${tableColumns.map(col => `'${col.name}'`).join(', ')})`
                                        : 'Enter your SQL query here...'
                                    "></textarea>
                            </div>
                            <div class="flex gap-2">
                                <button class="btn btn-primary" @click="executeQuery()"
                                    :disabled="!queryText.trim() || loading">
                                    <i data-lucide="play"></i>
                                    Execute
                                </button>
                                <button class="btn btn-secondary" @click="queryText = ''">
                                    Clear
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>


    <template x-if="isAuthenticated || sharedDb">
        <!-- delete row modal -->
        <div>
            <div x-show="showRowDropdown!=null" @click.self="showRowDropdown = null" class="modal">
                <div class="modal-content">
                    <h3 style="margin-bottom: 16px;">You've selected row #<span
                            x-text="showRowDropdown ? showRowDropdown.index + 1 : ''"></span></h3>
                    <button @click="deleteRow(showRowDropdown.row, showRowDropdown.index)"
                        style="padding: 6px 16px; color: white; margin-bottom:8px;"
                        class="btn btn-danger w-full text-left rounded-md cursor-pointer">
                        üóëÔ∏è Delete Row
                    </button>
                    <button type="button" class="btn btn-secondary" @click="showRowDropdown = null">Cancel</button>
                </div>
            </div>

            <!-- Delete Database Modal -->
            <div x-show="showDeleteModal" class="modal" @click.self="showDeleteModal = false">
                <div class="modal-content">
                    <h3 style="margin-bottom: 16px;">Are you sure you want to delete the
                        database
                        <strong class="text-[#2563eb]" x-text="selectedDb ? selectedDb.name : ''"></strong>? This action
                        cannot be undone.
                    </h3>
                    <form @submit.prevent="deleteDatabase(selectedDb.id)">
                        <div class="form-group">
                            <label class="text-sm mt-4">Type the database name to
                                confirm</label>
                            <input type="text" class="form-control" x-model="deleteDbName" required
                                placeholder="Enter database name to confirm">
                        </div>
                        <div class="flex gap-2">
                            <button type="submit" class="btn btn-danger"
                                :disabled="deleteDbName !== (selectedDb ? selectedDb.name : '') || loading">
                                <span x-text="loading ? 'Deleting...' : 'Delete'"></span>
                            </button>
                            <button type="button" class="btn btn-secondary"
                                @click="showDeleteModal = false">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Create Database Modal -->
            <div x-show="showCreateModal" class="modal" @click.self="showCreateModal = false">
                <div class="modal-content">
                    <h3 style="margin-bottom: 16px;">Create New Database</h3>
                    <form @submit.prevent="createDatabase()">
                        <div class="form-group">
                            <label>Database Name</label>
                            <input type="text" class="form-control" x-model="newDbName" required
                                placeholder="Enter database name">
                        </div>
                        <div class="flex gap-2">
                            <button type="submit" class="btn btn-primary" :disabled="!newDbName.trim() || loading">
                                <span x-text="loading ? 'Creating...' : 'Create'"></span>
                            </button>
                            <button type="button" class="btn btn-secondary"
                                @click="showCreateModal = false">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Create Table Modal -->
            <div x-show="showTableModal && selectedDb" class="modal" @click.self="showTableModal = false">
                <div class="modal-content">
                    <h3 style="margin-bottom: 16px;">Create New Table</h3>
                    <form @submit.prevent="createTable(); showTableModal = false; resetTableForm();">
                        <div class="form-group">
                            <label>Table Name</label>
                            <input type="text" class="form-control" x-model="newTableForm.name" required
                                placeholder="Enter table name">
                        </div>
                        <div class="form-group">
                            <label>Columns (SQL format)</label>
                            <textarea class="form-control" x-model="newTableForm.columns" required
                                placeholder="id INTEGER PRIMARY KEY, name TEXT NOT NULL, email TEXT UNIQUE"
                                rows="4"></textarea>
                            <small style="color: #888; font-size: 11px;">Example: id INTEGER PRIMARY KEY, name TEXT NOT
                                NULL,
                                email TEXT</small>
                        </div>
                        <div class="flex gap-2">
                            <button type="submit" class="btn btn-primary"
                                :disabled="!newTableForm.name.trim() || !newTableForm.columns.trim() || loading">
                                <span x-text="loading ? 'Creating...' : 'Create Table'"></span>
                            </button>
                            <button type="button" class="btn btn-secondary"
                                @click="showTableModal = false; resetTableForm()">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Insert Data Modal -->
            <div x-show="showInsertModal && selectedTable && selectedDb" class="modal"
                @click.self="showInsertModal = false">
                <div class="modal-content">
                    <h3 style="margin-bottom: 16px;">Insert Data</h3>
                    <form @submit.prevent="insertData()">
                        <div class="form-group">
                            <label>Table Name</label>
                            <template x-if="!selectedTable">
                                <input type="text" class="form-control" x-model="insertForm.table"
                                    placeholder="Enter table name" required />
                            </template>
                            <template x-if="selectedTable">
                                <input type="text" class="form-control" :value="selectedTable"
                                    :placeholder="selectedTable" readonly />
                            </template>
                        </div>
                        <div class="form-group">
                            <label>Columns (comma-separated)</label>
                            <template x-if="!selectedTable">
                                <input type="text" required class="form-control" x-model="insertForm.columns"
                                    placeholder="'name', 'email', age" />
                            </template>
                            <template x-if="selectedTable">
                                <input type="text" class="form-control"
                                    :value="tableColumns.length > 0 ? tableColumns.map(col => col.name).join(', ') : ''"
                                    :placeholder="tableColumns.length > 0 ? tableColumns.map(col => col.name).join(', ') : 'name, email, age'"
                                    readonly />
                            </template>
                        </div>
                        <div class="form-group">
                            <label>Values (comma-separated)</label>
                            <input type="text" class="form-control" x-model="insertForm.values" required
                                :placeholder="`'John Doe', 'john@example.com', 30`">
                        </div>
                        <div class="flex gap-2">
                            <button type="submit" class="btn btn-success"
                                :disabled="!insertForm.values.trim() || loading">
                                <span x-text="loading ? 'Inserting...' : 'Insert Data'"></span>
                            </button>
                            <button type="button" class="btn btn-secondary"
                                @click="showInsertModal = false; resetInsertForm()">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Delete Table Modal -->
            <div x-show="showDeleteTableModal" class="modal" @click.self="showDeleteTableModal = false">
                <div class="modal-content">
                    <h3 style="margin-bottom: 16px;">Are you sure you want to delete table
                        <strong class="text-[#2563eb]" x-text="selectedTable? selectedTable : ''"></strong>?
                    </h3>

                    <div class="flex gap-2">
                        <button @click="deleteTable" class="btn btn-danger" :disabled="loading">
                            <span x-text="loading ? 'Deleting...' : 'Delete'"></span>
                        </button>
                        <button type="button" class="btn btn-secondary"
                            @click="showDeleteTableModal = false">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <script>
        function sqlitePanel() {
            return {
                // Authentication state
                isAuthenticated: false,
                authMode: 'login',
                user: null,
                authFormRegister: { username: '', password: '', email: '' },
                authFormLogin: { username: '', password: '' },

                // UI state
                loading: false,
                screenLoading: false,
                message: { text: '', type: '' },

                // Database state
                databases: [],
                selectedDb: null,
                tables: [],
                selectedTable: null,
                tableData: [],
                tableColumns: [],
                filterText: '',
                editingCell: null,
                selectedRow: null,
                index: 0,

                // Modals
                showCreateModal: false,
                showTableModal: false,
                showInsertModal: false,
                showDeleteModal: false,
                showDeleteTableModal: false,
                deleteDbName: '',
                sharedDbName: '',
                showRowDropdown: null,
                showDeleteRowModal: { show: false, row: null, index: null },
                showEditRowModal: false,
                selectShowDeleteRowIcon: false,

                // Forms
                newDbName: '',
                newTableForm: { name: '', columns: '' },
                insertForm: { table: '', columns: '', values: '' },

                // Query state
                queryText: '',
                queryResults: null,

                insertRow: {},

                // Shared database state
                sharedToken: '',
                sharedDb: null,

                init() {
                    this.checkAuth();
                },

                // Utility methods
                setMessage(text, type = 'success') {
                    this.message = { text, type };
                    setTimeout(() => {
                        this.message = { text: '', type: '' };
                    }, 5000);
                },

                async apiCall(url, options = {}) {
                    try {
                        const response = await fetch(url, {
                            credentials: 'include',
                            headers: {
                                'Content-Type': 'application/json',
                                ...options.headers
                            },
                            ...options
                        });

                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(errorText || `HTTP ${response.status}`);
                        }

                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            return await response.json();
                        }
                        return null;
                    } catch (error) {
                        throw error;
                    }
                },

                // Authentication methods
                async checkAuth() {
                    this.screenLoading = true
                    try {
                        const result = await this.apiCall('/api/authenticate');
                        this.user = result?.data.user.username || null;
                        this.isAuthenticated = result?.data.authenticated || false;
                        // console.log(result.data)
                        if (this.isAuthenticated) {
                            this.loadDatabases();
                        }
                    } catch (error) {
                        this.isAuthenticated = false;
                        this.user = null;
                    }
                    this.screenLoading = false
                },

                async register() {
                    if (!this.authFormRegister.username.trim() || !this.authFormRegister.password.trim() || !this.authFormRegister.email.trim()) return;

                    this.loading = true;
                    try {
                        await this.apiCall('/api/register', {
                            method: 'POST',
                            body: JSON.stringify(this.authFormRegister)
                        });
                        this.setMessage('Registration successful! Please login.', 'success');
                        this.authMode = 'login';
                        this.authFormRegister = { username: '', password: '', email: '' };
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                    this.loading = false;
                },

                async login() {
                    if (!this.authFormLogin.username.trim() || !this.authFormLogin.password.trim()) return;

                    this.loading = true;
                    try {
                        const result = await this.apiCall('/api/login', {
                            method: 'POST',
                            body: JSON.stringify(this.authFormLogin)
                        });

                        this.isAuthenticated = true;
                        this.user = result?.user || this.authFormLogin.username;
                        this.setMessage('Login successful!', 'success');
                        this.loadDatabases();
                        this.authFormLogin = { username: '', password: '' };
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                    this.loading = false;
                },

                async logout() {
                    try {
                        await this.apiCall('/api/logout', { method: 'POST' });
                        this.isAuthenticated = false;
                        this.user = null;
                        this.databases = [];
                        this.selectedDb = null;
                        this.queryResults = null;
                        this.setMessage('Logged out successfully', 'success');
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                },

                // Database management methods
                async loadDatabases() {
                    try {
                        const result = await this.apiCall('/api/databases');
                        this.databases = result.data || [];
                    } catch (error) {
                        this.setMessage('Failed to load databases', 'error');
                    }
                },

                async createDatabase() {
                    if (!this.newDbName.trim()) return;

                    this.loading = true;
                    try {
                        const result = await this.apiCall('/api/databases', {
                            method: 'POST',
                            body: JSON.stringify({ name: this.newDbName })
                        });

                        this.newDbName = '';
                        this.showCreateModal = false;
                        this.loadDatabases();
                        if (this.selectedDb) {
                            this.selectedDb = result.data || [];
                        }
                        this.setMessage('Database created successfully!', 'success');
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                    this.loading = false;
                },

                async deleteDatabase(id) {
                    try {
                        if (!id || !this.selectedDb) return;
                        if (this.deleteDbName !== this.selectedDb.name) {
                            this.setMessage('Please enter the correct database name to confirm deletion.', 'error');
                            return;
                        }
                        this.loading = true;

                        await this.apiCall(`/api/databases/${id}`, { method: 'DELETE' });
                        this.loadDatabases();
                        if (this.selectedDb && this.selectedDb.id === id) {
                            this.selectedDb = null;
                            this.queryResults = null;
                            this.showDeleteModal = false;
                            this.deleteDbName = '';
                        }
                        this.setMessage('Database deleted successfully', 'success');
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                    this.loading = false;
                },

                async shareDatabase(database) {
                    try {
                        if (database.is_shared) {
                            // Disable sharing
                            await this.apiCall(`/api/databases/${database.id}/share`, { method: 'DELETE' });
                            this.setMessage('Database sharing disabled', 'success');
                        } else {
                            // Enable sharing
                            const result = await this.apiCall(`/api/databases/${database.id}/share`, { method: 'POST' });
                            this.setMessage(`Database shared! Token: ${result.token}`, 'success');
                        }
                        this.loadDatabases();
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                },

                async selectDatabase(database) {
                    this.selectedDb = database;
                    this.selectedTable = null;
                    this.tables = [];
                    this.tableData = [];
                    this.tableColumns = [];
                    this.queryResults = null;
                    this.queryText = '';
                    this.loading = true;
                    try {
                        // Load tables for the selected database
                        const result = await this.apiCall(`/api/databases/${database.id}/tables`);
                        this.tables = result.data || [];
                    } catch (error) {
                        this.setMessage('Failed to load tables', 'error');
                    }
                    this.loading = false;
                },

                async addRow() {
                    // Check if all required fields in insertRow are filled
                    if (!this.selectedTable || !this.selectedDb || !this.tableColumns.length) return;
                    const values = this.tableColumns.map(col => this.insertRow[col.name]);
                    if (values.some(v => v === undefined || v === null || v === "")) return;
                    this.loading = true;

                    try {
                        await this.apiCall(`/api/databases/${this.selectedDb.id}/data`, {
                            method: 'POST',
                            body: JSON.stringify({
                                table: this.selectedTable,
                                columns: this.tableColumns.map(col => col.name).join(', '),
                                values: values.map(v => typeof v === 'string' ? `'${v}'` : v).join(', ')
                            })
                        });
                        // Clear insertRow fields
                        this.insertRow = {};
                        // Reload table data
                        await this.selectTable(this.selectedTable);
                        this.setMessage('Row added successfully!', 'success');
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                    this.loading = false;
                },

                async deleteRow(selectedRow, index) {
                    if (!this.selectedDb || !this.selectedTable) return;
                    // Build condition using all columns to uniquely identify the row
                    const condition = {};
                    this.tableColumns.forEach((col, i) => {
                        condition[col.name] = Array.isArray(selectedRow) ? selectedRow[i] : selectedRow[col.name];
                    });

                    this.loading = true;
                    try {
                        await this.apiCall(`/api/databases/${this.selectedDb.id}/tables/${this.selectedTable}/data`, {
                            method: 'DELETE',
                            body: JSON.stringify({ condition })
                        });
                        // Reload table data
                        await this.selectTable(this.selectedTable);
                        this.setMessage('Row deleted successfully!', 'success');
                        this.showRowDropdown = null;
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                    this.loading = false;
                },

                // Query execution methods
                async executeQuery() {
                    if (!this.queryText.trim() || !this.selectedDb) return;

                    this.loading = true;
                    try {
                        const result = await this.apiCall(`/api/databases/${this.selectedDb.id}/query`, {
                            method: 'POST',
                            body: JSON.stringify({ sql: this.queryText })
                        });
                        console.log(result)
                        // Optionally handle query results here
                        this.setMessage('Query executed successfully!', 'success');

                        // Reload tables after creation
                        const results = await this.apiCall(`/api/databases/${this.selectedDb.id}/tables`);
                        this.tables = results.data || [];

                        // Optionally reload table data if needed
                        if (this.selectedTable) {
                            await this.selectTable(this.selectedTable);
                        }
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                    this.loading = false;
                },

                // Table management methods
                async createTable() {
                    if (!this.newTableForm.name.trim() || !this.newTableForm.columns.trim() || !this.selectedDb) return;

                    this.loading = true;
                    try {
                        await this.apiCall(`/api/databases/${this.selectedDb.id}/tables`, {
                            method: 'POST',
                            body: JSON.stringify({
                                name: this.newTableForm.name,
                                columns: this.newTableForm.columns
                            })
                        });

                        this.showTableModal = false;
                        this.resetTableForm();
                        // Reload tables after creation
                        const result = await this.apiCall(`/api/databases/${this.selectedDb.id}/tables`);
                        this.tables = result.data || [];
                        this.setMessage('Table created successfully!', 'success');
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                    this.loading = false;
                },

                async deleteTable() {
                    const tableName = this.selectedTable
                    this.loading = true;
                    try {
                        await this.apiCall(`/api/databases/${this.selectedDb.id}/tables/${tableName}`, { method: 'DELETE' });
                        // Reload tables after deletion
                        const result = await this.apiCall(`/api/databases/${this.selectedDb.id}/tables`);
                        this.tables = result.data || [];
                        if (this.selectedTable) {
                            this.selectedTable = null;
                            this.tableData = [];
                            this.tableColumns = [];
                            this.showDeleteTableModal = false
                        }
                        this.setMessage('Table deleted successfully!', 'success');
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                    this.loading = false;
                },

                // Data insertion methods
                async insertData() {
                    if (
                        !this.selectedTable.trim() ||
                        !this.insertForm.values.trim() ||
                        !this.selectedDb
                    ) {
                        console.log(this.insertForm)
                        this.setMessage('Please fill all fields before inserting data.', 'error');
                        return;
                    }

                    this.loading = true;
                    try {
                        await this.apiCall(`/api/databases/${this.selectedDb.id}/data`, {
                            method: 'POST',
                            body: JSON.stringify({
                                table: this.selectedTable ? this.selectedTable : this.insertForm.table,
                                columns: this.selectedTable ? this.tableColumns.map(col => col.name).join(", ") : this.insertForm.columns,
                                values: this.insertForm.values
                            })
                        });

                        this.showInsertModal = false;
                        this.resetInsertForm();
                        if (this.selectedTable) {
                            await this.selectTable(this.selectedTable);
                        }
                        this.setMessage('Data inserted successfully!', 'success');
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                    this.loading = false;
                },

                // Shared database methods
                async accessSharedDatabase() {
                    if (!this.sharedToken.trim()) return;

                    this.loading = true;
                    try {
                        const result = await this.apiCall(`/api/shared/${this.sharedToken}`);
                        this.sharedDb = result.database;
                        this.selectedDb = result.database;
                        this.tables = [];
                        this.selectedTable = null;
                        this.tableData = [];
                        this.tableColumns = [];
                        // Load tables for shared database
                        const tablesResult = await this.apiCall(`/api/databases/${this.sharedDb.id}/tables`);
                        this.tables = tablesResult.data || [];
                        this.setMessage('Shared database accessed successfully!', 'success');
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                    this.loading = false;
                },

                // Table selection and data loading
                async selectTable(table) {
                    this.selectedTable = table;
                    this.tableData = [];
                    this.tableColumns = [];
                    this.loading = true;
                    try {
                        const result = await this.apiCall(`/api/databases/${this.selectedDb.id}/tables/${table}/data`);
                        console.log(result.data)
                        this.tableData = result.data.values || [];
                        this.tableColumns = result.data.columns || [];
                    } catch (error) {
                        this.setMessage('Failed to load table data', 'error');
                    }
                    this.loading = false;
                },

                //update table cell
                async updateCell(index, column, newValue, oldValue) {
                    if (!this.selectedDb || !this.selectedTable) return;
                    // Find the row to update
                    const row = this.filteredTableData[index];
                    if (!row) return;

                    // Build condition (use all columns as condition for now)
                    const condition = {};
                    this.tableColumns.forEach((col, i) => {
                        // Use value from row (array or object)
                        condition[col.name] = Array.isArray(row) ? row[i] : row[col.name];
                    });

                    // Only update the changed column
                    const data = {};
                    data[column] = newValue;

                    // If oldValue is undefined or null, try to use the value from the row
                    let oldVal = oldValue;
                    if (oldVal === undefined || oldVal === null) {
                        const colIndex = this.tableColumns.findIndex(col => col.name === column);
                        oldVal = Array.isArray(row) ? row[colIndex] : row[column];
                    }

                    // If oldVal is still null/undefined, set to empty string
                    if (oldVal === undefined || oldVal === null) oldVal = '';

                    this.loading = true;
                    try {
                        await this.apiCall(`/api/databases/${this.selectedDb.id}/tables/${this.selectedTable}/data`, {
                            method: 'PUT',
                            body: JSON.stringify({
                                condition,
                                data,
                                oldValue: oldVal
                            })
                        });
                        // Reload table data
                        await this.selectTable(this.selectedTable);
                        this.setMessage('Cell updated successfully!', 'success');
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                    this.loading = false;
                },

                // Filtered table data
                get filteredTableData() {
                    if (!this.filterText.trim()) return this.tableData;
                    const filter = this.filterText.toLowerCase();
                    return this.tableData.filter(row =>
                        Object.values(row).some(
                            val => val !== null && String(val).toLowerCase().includes(filter)
                        )
                    );
                },

                // Form reset methods
                resetTableForm() {
                    this.newTableForm = { name: '', columns: '' };
                },

                resetInsertForm() {
                    this.insertForm = { table: '', columns: '', values: '' };
                }
            }
        }
    </script>
</body>

</html>