<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ .Title }}</title>
    <meta http-equiv="X-UA-Compatible" content="IE=7">
    <meta name="description"
        content="Host and manage your SQLite databases in the cloud with unparalleled speed and simplicity">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="keywords" content="SQLite, SQL, databases, cloud, hosting, edge computing">
    <link rel="shortcut icon" href="/static/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="/static/style.css">
    <link rel="apple-touch-icon" href="/static/favicon.png">
    <script defer src="/static/tailwindcss.js"></script>
    <script defer src="/static/alpine.js"></script>
</head>

<body x-data="sqlitePanel()" x-init="init()">
    <!-- loading Screen -->
    <template x-if="screenLoading">
        <div class="screen-loading-overlay">
            <div class="spinner"></div>
        </div>
    </template>

    <!-- Authentication Screen -->
    <template x-if="!isAuthenticated && !sharedDb">
        <div class="auth-container">
            <div class="card">
                <div class="header">
                    <h1>
                        <span
                            x-text="authMode === 'login'?'Sign in to VileSQL':authMode === 'register'?'Welcome to VileSQL':'Forgot Password'"></span>
                    </h1>
                </div>

                <div style="padding: 20px;">
                    <div x-show="message.text" class="alert"
                        :class="message.type === 'error' ? 'alert-error' : 'alert-success'">
                        <span x-text="message.text"></span>
                    </div>

                    <div class="tab-nav">
                        <button class="tab-btn" :class="authMode === 'login' ? 'active' : ''"
                            @click="authMode = 'login'">
                            Login
                        </button>
                        <button class="tab-btn" :class="authMode === 'register' ? 'active' : ''"
                            @click="authMode = 'register'">
                            Register
                        </button>
                        <button class="tab-btn" :class="authMode === 'forgot' ? 'active' : ''"
                            @click="authMode = 'forgot'">
                            Forgot Password
                        </button>
                    </div>

                    <form @submit.prevent="
                        authMode === 'login' ? login() : 
                        authMode === 'register' ? register() : 
                        authMode === 'forgot' && showEnterOTPInput === true ? verifyOTP() : 
                        authMode === 'forgot' && showEnterOTPInput === false && authFormForgot.otp === null ? verify() : 
                        authMode === 'forgot' && showEnterOTPInput === false && authFormForgot.otp !== null ? password_reset() : 
                        null
                    " style="padding: 20px 0;">
                        <template x-if="authMode === 'login'">
                            <div>
                                <div class="form-group">
                                    <label>Username</label>
                                    <input type="text" class="form-control" x-model="authFormLogin.username" required>
                                </div>
                                <div class="form-group">
                                    <div class="flex justify-between w-full items-center">
                                        <label>Password</label>
                                        <span class="text-blue-500 cursor-pointer" @click="authMode = 'forgot'">Forgot
                                            Password</span>
                                    </div>
                                    <input type="password" class="form-control" x-model="authFormLogin.password"
                                        required>
                                </div>
                            </div>
                        </template>
                        <template x-if="authMode === 'forgot'">
                            <div>
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email" class="form-control" x-model="authFormForgot.email"
                                        placeholder="Confirm your email">
                                </div>
                                <div x-show="showEnterOTPInput && verificationOTP !== null" class="form-group">
                                    <label>Enter Verification Code</label>
                                    <input type="text" class="form-control" x-model="authFormForgot.otp"
                                        placeholder="Enter the OTP sent to your email">
                                </div>
                                <div x-show="!showEnterOTPInput && authFormForgot.otp !== null">
                                    <div class="form-group">
                                        <label>New Password</label>
                                        <input type="password" class="form-control"
                                            x-model="authFormForgot.new_password">
                                    </div>
                                    <div class="form-group">
                                        <label class="flex justify-between w-full items-center">
                                            <span>Confirm Password</span>
                                        </label>
                                        <input type="password" class="form-control"
                                            x-model="authFormForgot.confirm_password">
                                    </div>
                                </div>
                            </div>
                        </template>
                        <template x-if="authMode === 'register'">
                            <div>
                                <div class="form-group">
                                    <label>Username</label>
                                    <input type="text" class="form-control" x-model="authFormRegister.username"
                                        required>
                                </div>
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email" class="form-control" x-model="authFormRegister.email" required>
                                </div>
                                <div class="form-group">
                                    <label>Password</label>
                                    <input type="password" class="form-control" x-model="authFormRegister.password"
                                        required>
                                </div>
                            </div>
                        </template>
                        <button type="submit" class="btn btn-primary" style="width: 100%;" :disabled="loading">
                            <template x-if="loading">
                                <div class="spinner" style="width: 16px; height: 16px;"></div>
                            </template>
                            <span x-text="loading ? 'Processing...' : (
                                authMode === 'login' ? 'Login' : 
                                authMode === 'register' ? 'Register' : 
                                authMode === 'forgot' && showEnterOTPInput === true ? 'Verify OTP' :
                                authMode === 'forgot' && showEnterOTPInput === false && authFormForgot.otp === null ? 'Send Reset Code' :
                                authMode === 'forgot' && showEnterOTPInput === false && authFormForgot.otp !== null ? 'Reset Password' :
                                'Submit'
                            )"></span>
                        </button>
                    </form>

                    <div style="border-top: 1px solid #444; padding-top: 16px;">
                        <div class="section-header">Access Shared Database</div>
                        <form @submit.prevent="accessSharedDatabase()" class="flex gap-2">
                            <input type="text" class="form-control" x-model="sharedToken"
                                placeholder="Enter share token">
                            <button class="btn btn-secondary" :disabled="!sharedToken">
                                <!-- share svg -->
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none"
                                    style="vertical-align: middle; margin-right: 4px;"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="12" cy="4" r="2" fill="#ffff" />
                                    <circle cx="4" cy="8" r="2" fill="#ffff" />
                                    <circle cx="12" cy="12" r="2" fill="#ffff" />
                                    <line x1="5.7" y1="8.7" x2="10.3" y2="11.3" stroke="#ffff" stroke-width="1.2" />
                                    <line x1="10.3" y1="4.7" x2="5.7" y2="7.3" stroke="#ffff" stroke-width="1.2" />
                                </svg>
                                Access
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- Main Application -->
    <template x-if="isAuthenticated || sharedDb">
        <div>
            <!-- Navigation Bar -->
            <nav class="navbar">
                <div class="navbar-left">
                    <!-- <a href="#" class="navbar-brand">VileSQL</a> -->
                    <ul class="navbar-nav">
                        <!-- <li>
                            <p @click="page = 'home'" :class="page === 'home' ? 'nav-link active' : 'nav-link'">Home</p>
                        </li> -->
                        <template x-if="!sharedDb &&!selectedDb">
                            <li>
                                <p @click="page = 'database'; selectedDb=null"
                                    :class="page === 'database' ? 'nav-link active' : 'nav-link'">
                                    Databases</p>
                            </li>
                        </template>
                        <template x-if="selectedDb">
                            <li class="workspace-name">
                                <!-- Pink SQL Database SVG Icon -->
                                <svg width="18" height="18" viewBox="0 0 20 20" fill="none" style="flex-shrink:0;"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <ellipse cx="10" cy="5" rx="8" ry="3" fill="#ec4899" />
                                    <ellipse cx="10" cy="10" rx="8" ry="3" fill="#ec4899" fill-opacity="0.8" />
                                    <ellipse cx="10" cy="15" rx="8" ry="3" fill="#ec4899" fill-opacity="0.6" />
                                </svg>
                                <p x-text="selectedDb.name.replace('_',' ')"></p>
                            </li>
                        </template>
                    </ul>
                </div>
                <div class="navbar-right">
                    <template x-if="!selectedDb">
                        <div class="search-container">
                            <input type="search" class="search-input" placeholder="Search Databases" x-model="searchQuery"
                                @keydown.enter="searchDatabases()">
                            <span class="search-shortcut">⌘K</span>
                        </div>
                    </template>
                    <template x-if="selectedDb">
                        <button class="btn btn-primary" @click="showTableModal = true">
                            <!-- Table SVG Icon -->
                            <svg class="table-icon" width="12" height="12" viewBox="0 0 16 16" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <rect x="1" y="2" width="14" height="12" rx="2" fill="#60a5fa" />
                                <rect x="1" y="5" width="14" height="1" fill="#2563eb" />
                                <rect x="1" y="8" width="14" height="1" fill="#2563eb" />
                                <rect x="1" y="11" width="14" height="1" fill="#2563eb" />
                            </svg>
                            New Table
                        </button>
                    </template>
                    <template x-if="isAuthenticated && selectedDb && !sharedToken">
                        <button class="btn btn-danger" style="margin-left: auto;" @click="showDeleteModal = true">
                            <!-- trash icon -->
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" style="vertical-align: middle;"
                                xmlns="http://www.w3.org/2000/svg">
                                <rect x="3" y="6" width="10" height="7" rx="2" fill="#fff" fill-opacity="0.15" />
                                <rect x="3" y="6" width="10" height="7" rx="2" stroke="#fff" stroke-width="1" />
                                <rect x="7" y="9" width="2" height="3" rx="1" fill="#fff" />
                                <rect x="5" y="3" width="6" height="2" rx="1" fill="#fff" />
                                <rect x="6" y="2" width="4" height="1" rx="0.5" fill="#fff" fill-opacity="0.5" />
                                <rect x="2" y="5" width="12" height="1" fill="#fff" />
                                <line x1="6" y1="8" x2="10" y2="12" stroke="#d83b01" stroke-width="1.5" />
                                <line x1="10" y1="8" x2="6" y2="12" stroke="#d83b01" stroke-width="1.5" />
                            </svg>
                            Delete DB
                        </button>
                    </template>

                    <button x-show="selectedDb" class="btn btn-secondary" @click="tab='info'; showConfigModal = true"
                        title="Database Info & Connection">
                        <!-- gear icon -->
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" style="vertical-align: middle;"
                            xmlns="http://www.w3.org/2000/svg">
                            <circle cx="8" cy="8" r="2" fill="#fff" />
                            <path d="M2 8a6 6 0 0 1 12 0" stroke="#fff" stroke-width="1.2" fill="none" />
                            <path
                                d="M8 2v2M8 12v2M2 8h2M12 8h2M3.5 3.5l1.5 1.5M11 11l1.5 1.5M3.5 12.5l1.5-1.5M11 5l1.5-1.5"
                                stroke="#fff" stroke-width="1" fill="none" />
                        </svg>
                        Configurations
                    </button>
                    <button class="theme-toggle" onclick="toggleTheme()">🌙</button>
                    <button @click="userModal=true" x-show="user"
                        class="flex items-center justify-center cursor-pointer w-[30px] rounded-[50px] bg-[var(--color-primary)] h-[30px] text-[10px] text-white font-semibold"
                        x-text="user?user.username.slice(0,2).toUpperCase():''"></button>
                    <a href="https://github.com/sponsors/imrany" target="_blank" rel="noopener noreferrer"
                        class="btn btn-primary" x-show="!sharedToken">Upgrade</a>
                    <button class="btn btn-primary" x-show="sharedToken" @click="logout()">Sign Out</button>
                </div>
            </nav>

            <!-- Main Container -->
            <div class="main-container" x-show="page==='database'">
                <template x-if="!selectedDb && !sharedToken">
                    <div class="flex flex-col items-center justify-center">
                        <div class="w-[80vw]">
                            <!-- Page Header -->
                            <div class="page-header">
                                <!-- <p @click="page ==='home'?page='database':page='home'" class="go-back-link">
                                    ← Go back
                                </p> -->
                                <div class="page-header-top">
                                    <div>
                                        <h1 class="page-title"
                                            x-text="databases.length === 0 && !sharedToken?'No database':'All databases'">
                                        </h1>
                                        <p class="page-subtitle"
                                            x-text="databases.length === 0 && !sharedToken?'':`A directory of all databases in ${user.username}, you can access.`">
                                        </p>
                                    </div>
                                    <div class="page-actions">
                                        <button x-show="!sharedToken" class="btn btn-primary" style="width: 100%;"
                                            @click="showCreateModal = true">
                                            <!-- plus icon -->
                                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"
                                                style="vertical-align: middle;" xmlns="http://www.w3.org/2000/svg">
                                                <rect x="7" y="2" width="2" height="12" rx="1" fill="#fff" />
                                                <rect x="2" y="7" width="12" height="2" rx="1" fill="#fff" />
                                            </svg>
                                            Create Database
                                        </button>
                                    </div>
                                </div>
                                <div x-show="databases.length > 0 || sharedToken" class="tab-navigation">
                                    <a href="#" class="tab-item active">Databases</a>
                                    <a href="#" class="tab-item">Public Databases</a>
                                </div>
                            </div>
    
                            <template x-if="databases.length > 0">
                                <div style="margin-bottom: 60px;">
                                    <!-- Filters Section -->
                                    <div class="filters-section">
                                        <div class="search-container">
                                            <input type="search" class="search-input" placeholder="Search Databases"
                                                x-model="searchQuery" @keydown.enter="searchDatabases()">
                                            <span class="search-shortcut">⌘K</span>
                                        </div>
                                        <div class="filter-group">
                                            <select class="filter-select">
                                                <option>Access</option>
                                                <option value="private">Private</option>
                                                <option value="public">Public</option>
                                            </select>
                                        </div>
                                    </div>
    
                                    <!-- Content Section -->
                                    <div class="content-section">
                                        <div class="table-container">
                                            <table class="workspace-table">
                                                <thead>
                                                    <tr>
                                                        <th>Name</th>
                                                        <th>Created by</th>
                                                        <th>Type</th>
                                                        <th>Access</th>
                                                        <th>Last updated</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <template x-for="db in databases" :key="db.id">
                                                        <tr @click="selectDatabase(db)">
                                                            <td>
                                                                <div class="workspace-name">
                                                                    <!-- Pink SQL Database SVG Icon -->
                                                                    <svg width="18" height="18" viewBox="0 0 20 20"
                                                                        fill="none" style="flex-shrink:0;"
                                                                        xmlns="http://www.w3.org/2000/svg">
                                                                        <ellipse cx="10" cy="5" rx="8" ry="3"
                                                                            fill="#ec4899" />
                                                                        <ellipse cx="10" cy="10" rx="8" ry="3"
                                                                            fill="#ec4899" fill-opacity="0.8" />
                                                                        <ellipse cx="10" cy="15" rx="8" ry="3"
                                                                            fill="#ec4899" fill-opacity="0.6" />
                                                                    </svg>
    
                                                                    <div>
                                                                        <div class="workspace-title" x-text="db.name"></div>
                                                                        <div class="workspace-meta">1 contributor</div>
                                                                    </div>
                                                                </div>
                                                            </td>
                                                            <td>
                                                                <div class="user-info">
                                                                    <div class="user-avatar">Y</div>
                                                                    <span>You</span>
                                                                </div>
                                                            </td>
                                                            <td>Internal</td>
                                                            <td>
                                                                <span
                                                                    x-text="db.share_token?'Only you and invited people':'Private'"
                                                                    :class="db.share_token?'access-badge':'access-badge private'"></span>
                                                            </td>
                                                            <td class="last-updated"
                                                                x-text="new Date(db.created_at).toLocaleDateString()"></td>
                                                        </tr>
                                                    </template>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </template>
    
                            <!-- Footer -->
                            <footer
                                style="position: fixed; padding: 16px 0; left: 0; bottom: 0; width: 100%; background: var(--color-bg); z-index: 50;">
                                <ul class="flex flex-wrap justify-center gap-6">
                                    <li>
                                        <a href="https://github.com/imrany/vilesql"
                                            style="font-size: var(--font-size-small); color: var(--color-text-secondary);"
                                            class="flex items-center justify-center gap-1" target="_blank"
                                            rel="noopener noreferrer">
                                            <!-- GitHub SVG icon -->
                                            <svg width="15" height="15" viewBox="0 0 24 24" fill="currentColor"
                                                style="vertical-align: middle;" xmlns="http://www.w3.org/2000/svg">
                                                <path
                                                    d="M12 2C6.477 2 2 6.484 2 12.021c0 4.428 2.865 8.184 6.839 9.504.5.092.682-.217.682-.483 0-.237-.009-.868-.014-1.703-2.782.605-3.369-1.342-3.369-1.342-.454-1.154-1.11-1.462-1.11-1.462-.908-.62.069-.608.069-.608 1.004.07 1.532 1.032 1.532 1.032.892 1.53 2.341 1.088 2.91.832.091-.647.35-1.088.636-1.339-2.221-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.254-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.025A9.564 9.564 0 0 1 12 6.844c.85.004 1.705.115 2.504.337 1.909-1.295 2.748-1.025 2.748-1.025.546 1.378.202 2.396.1 2.65.64.7 1.028 1.595 1.028 2.688 0 3.847-2.337 4.695-4.566 4.944.359.309.678.919.678 1.852 0 1.336-.012 2.417-.012 2.747 0 .268.18.579.688.481C19.138 20.2 22 16.447 22 12.021 22 6.484 17.523 2 12 2z" />
                                            </svg>
                                            Github Repository
                                        </a>
                                    </li>
                                    <li>
                                        <a href="https://github.com/sponsors/imrany"
                                            style="font-size: var(--font-size-small); color: var(--color-text-secondary);"
                                            class="flex items-center justify-center gap-1" target="_blank"
                                            rel="noopener noreferrer">
                                            <!-- Sponsor SVG icon (heart) -->
                                            <svg width="15" height="15" viewBox="0 0 24 24" fill="currentColor"
                                                style="vertical-align: middle;" xmlns="http://www.w3.org/2000/svg">
                                                <path
                                                    d="M12 21s-6.716-5.686-9.364-8.334C.36 10.39.36 7.36 2.636 5.083c2.276-2.276 5.307-2.276 7.583 0L12 6.864l1.781-1.781c2.276-2.276 5.307-2.276 7.583 0 2.276 2.277 2.276 5.307 0 7.583C18.716 15.314 12 21 12 21z" />
                                            </svg>
                                            Be a Sponsor
                                        </a>
                                    </li>
                                </ul>
                            </footer>
                        </div>
                    </div>
                </template>

                <template x-if="selectedDb || sharedToken">
                    <div class="flex h-[100vh]">
                        <!-- Sidebar -->
                        <div class="sidebar">
                            <p x-show="!sharedToken" @click="selectedDb=null" style="padding: 8px;"
                                class="go-back-link">
                                ← Go back
                            </p>
                            <!-- Tables Section -->
                            <div x-show="selectedDb && tables.length > 0" class="tables-section flex-grow">
                                <div class="section-header">Tables</div>
                                <div class="section-body">
                                    <template x-for="table in tables" :key="table">
                                        <div class="table-item" :class="selectedTable === table ? 'active' : ''"
                                            @click="selectTable(table)">
                                            <!-- Table SVG Icon -->
                                            <svg class="table-icon" width="12" height="12" viewBox="0 0 16 16"
                                                fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <rect x="1" y="2" width="14" height="12" rx="2" fill="#60a5fa" />
                                                <rect x="1" y="5" width="14" height="1" fill="#2563eb" />
                                                <rect x="1" y="8" width="14" height="1" fill="#2563eb" />
                                                <rect x="1" y="11" width="14" height="1" fill="#2563eb" />
                                            </svg>
                                            <span x-text="table"></span>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>

                        <!-- Content Area -->
                        <div class="content-area" style="position: relative;">
                            <template x-if="loading">
                                <div class="loading-overlay">
                                    <div class="spinner"></div>
                                </div>
                            </template>

                            <!-- Toolbar -->
                            <template x-if="selectedDb&& selectedTable">
                                <div class="toolbar">
                                    <div class="flex gap-2 w-full">
                                        <button class="btn btn-success" @click="showInsertModal = true">
                                            <!-- plus icon -->
                                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"
                                                style="vertical-align: middle;" xmlns="http://www.w3.org/2000/svg">
                                                <rect x="7" y="2" width="2" height="12" rx="1" fill="#fff" />
                                                <rect x="2" y="7" width="12" height="2" rx="1" fill="#fff" />
                                            </svg>
                                            Insert Data
                                        </button>

                                        <button type="button" class="btn btn-secondary"
                                            @click="selectTable(selectedTable)">
                                            <!-- reload icon -->
                                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"
                                                style="vertical-align: middle; margin-right: 4px;"
                                                xmlns="http://www.w3.org/2000/svg">
                                                <path d="M2 8a6 6 0 1 1 2.47 4.85" stroke="#ffff" stroke-width="1.5"
                                                    fill="none" />
                                                <path d="M2 12v-3h3" stroke="#ffff" stroke-width="1.5" fill="none" />
                                            </svg>
                                            Reload Table
                                        </button>

                                        <button type="button" class="btn btn-secondary"
                                            @click="showQueryPanel? showQueryPanel = false: showQueryPanel = true">
                                            <!-- show icon -->
                                            <svg x-show="!showQueryPanel" width="16" height="16" viewBox="0 0 16 16"
                                                fill="none" style="vertical-align: middle; margin-right: 4px;"
                                                xmlns="http://www.w3.org/2000/svg">
                                                <circle cx="8" cy="8" r="7" stroke="#ffff" stroke-width="2"
                                                    fill="none" />
                                                <rect x="7" y="4" width="2" height="8" rx="1" fill="#ffff" />
                                                <rect x="4" y="7" width="8" height="2" rx="1" fill="#ffff" />
                                            </svg>
                                            <!-- hide icon -->
                                            <svg x-show="showQueryPanel" width="16" height="16" viewBox="0 0 16 16"
                                                fill="none" style="vertical-align: middle; margin-right: 4px;"
                                                xmlns="http://www.w3.org/2000/svg">
                                                <circle cx="8" cy="8" r="7" stroke="#ffff" stroke-width="2"
                                                    fill="none" />
                                                <rect x="4" y="7" width="8" height="2" rx="1" fill="#ffff" />
                                            </svg>
                                            <span
                                                x-text="showQueryPanel===false?'Show Query Panel':'Hide Query Panel'"></span>
                                        </button>

                                        <template x-if="isAuthenticated && !sharedToken">
                                            <button class="btn btn-danger" style="margin-left: auto;"
                                                @click="showDeleteTableModal=true">
                                                <!-- trash icon -->
                                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none"
                                                    style="vertical-align: middle;" xmlns="http://www.w3.org/2000/svg">
                                                    <rect x="3" y="6" width="10" height="7" rx="2" fill="#fff"
                                                        fill-opacity="0.15" />
                                                    <rect x="3" y="6" width="10" height="7" rx="2" stroke="#fff"
                                                        stroke-width="1" />
                                                    <rect x="7" y="9" width="2" height="3" rx="1" fill="#fff" />
                                                    <rect x="5" y="3" width="6" height="2" rx="1" fill="#fff" />
                                                    <rect x="6" y="2" width="4" height="1" rx="0.5" fill="#fff"
                                                        fill-opacity="0.5" />
                                                    <rect x="2" y="5" width="12" height="1" fill="#fff" />
                                                    <line x1="6" y1="8" x2="10" y2="12" stroke="#d83b01"
                                                        stroke-width="1.5" />
                                                    <line x1="10" y1="8" x2="6" y2="12" stroke="#d83b01"
                                                        stroke-width="1.5" />
                                                </svg>
                                                Delete Table
                                            </button>
                                        </template>
                                    </div>
                                </div>
                            </template>

                            <!-- Filter Bar -->
                            <div x-show="selectedTable && tableData.length > 0" class="filter-bar">
                                <label>Filter:</label>
                                <input type="text" class="filter-input" x-model="filterText"
                                    placeholder="Search in table...">
                                <span style="margin-left: auto; color: #888;"
                                    x-text="`${filteredTableData.length} rows`"></span>
                            </div>


                            <!-- Data Table -->
                            <div class="data-table-container">
                                <template x-if="!selectedDb">
                                    <div class="empty-state">
                                        <!-- database icon -->
                                        <svg width="48" height="48" viewBox="0 0 20 20" fill="none"
                                            style="flex-shrink:0;" xmlns="http://www.w3.org/2000/svg">
                                            <ellipse cx="10" cy="5" rx="8" ry="3" fill="#ec4899" />
                                            <ellipse cx="10" cy="10" rx="8" ry="3" fill="#ec4899" fill-opacity="0.8" />
                                            <ellipse cx="10" cy="15" rx="8" ry="3" fill="#ec4899" fill-opacity="0.6" />
                                        </svg>
                                        <h3>Select a database to get started</h3>
                                        <p>Choose a database from the sidebar to explore its contents</p>
                                    </div>
                                </template>

                                <template x-if="selectedDb && !selectedTable">
                                    <div class="empty-state">
                                        <!-- table icon -->
                                        <svg width="48" height="48" viewBox="0 0 16 16" fill="none"
                                            xmlns="http://www.w3.org/2000/svg">
                                            <rect x="1" y="2" width="14" height="12" rx="2" fill="#60a5fa" />
                                            <rect x="1" y="5" width="14" height="1" fill="#2563eb" />
                                            <rect x="1" y="8" width="14" height="1" fill="#2563eb" />
                                            <rect x="1" y="11" width="14" height="1" fill="#2563eb" />
                                        </svg>
                                        <h3>Select a table to view data</h3>
                                        <p>Choose a table from the sidebar or create a new one</p>
                                    </div>
                                </template>

                                <template x-if="selectedTable && tableColumns.length > 0">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th class="cursor-pointer row-number"
                                                    @click="tab ='editType'; showColumnInfo=true"
                                                    title="Click to open column modal">#</th>
                                                <template x-for="(column, colIndex) in tableColumns" :key="column.name">
                                                    <th style="min-width: 300px;" title="Click to edit column name"
                                                        @click="editingCell = { row: -1, col: column.name, value: column.name }">
                                                        <div class="flex justify-between items-center">
                                                            <template
                                                                x-if="editingCell && editingCell.row === -1 && editingCell.col === column.name">
                                                                <input type="text" class="form-control text-[11px]"
                                                                    x-model="editingCell.value"
                                                                    @keydown.enter.stop.prevent="
                                                                updateColumnName(editingCell);
                                                                editingCell = null;
                                                            " @keydown.esc="editingCell = null"
                                                                    @blur="editingCell = null"
                                                                    style="padding:2px 6px; min-width: 60px;" autofocus>
                                                            </template>
                                                            <template
                                                                x-if="!editingCell || editingCell.row !== -1 || editingCell.col !== column.name">
                                                                <span x-text="column.name"
                                                                    class="cursor-pointer"></span>
                                                            </template>
                                                            <template x-if="column.constraint">
                                                                <div
                                                                    class="text-[10px] text-[#60a5fa] mr-2 ml-auto flex gap-[2px] cursor-pointer">
                                                                    <span x-text="column.constraint.type"></span>
                                                                    <span
                                                                        x-text="column.constraint.unique ? 'UNIQUE' : ''"></span>
                                                                    <span
                                                                        x-text="column.constraint.primary_key ? 'PRIMARY' : ''"></span>
                                                                    <span
                                                                        x-text="column.constraint.not_null ? 'NOT NULL' : ''"></span>
                                                                </div>
                                                            </template>
                                                        </div>
                                                    </th>
                                                </template>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Data rows -->
                                            <template x-for="(row, index) in filteredTableData" :key="index">
                                                <tr>
                                                    <td class="row-number cursor-pointer"
                                                        x-text="selectShowDeleteRowIcon===index ? '🗑️' : index + 1"
                                                        @mouseover="selectShowDeleteRowIcon = index"
                                                        @mouseenter="selectShowDeleteRowIcon = index"
                                                        @mouseleave="selectShowDeleteRowIcon = null"
                                                        @click="showRowDropdown = { row: row, index: index }">
                                                    </td>

                                                    <template x-for="(column, colIndex) in tableColumns"
                                                        :key="column.name">
                                                        <td style="min-width: 300px;" @dblclick="
                                                        if (!editingCell || editingCell.row !== index || editingCell.col !== column.name) {
                                                            editingCell = { row: index, col: column.name, value: Array.isArray(row) ? row[colIndex] : row[column.name] }
                                                        }
                                                    ">
                                                            <template
                                                                x-if="editingCell && editingCell.row === index && editingCell.col === column.name">
                                                                <input
                                                                    :type="getInputType(column.constraint ? column.constraint.type : '')"
                                                                    class="form-control text-[11px]"
                                                                    x-model="editingCell.value"
                                                                    @keydown.enter.stop.prevent="
                                                                updateCell(index, column.name, editingCell.value, row[colIndex]);
                                                                editingCell = null;
                                                            " @keydown.esc="editingCell = null"
                                                                    @blur="editingCell = null"
                                                                    style="padding:2px 6px; min-width: 60px;" autofocus>
                                                            </template>
                                                            <template
                                                                x-if="!editingCell || editingCell.row !== index || editingCell.col !== column.name">
                                                                <span
                                                                    x-text="Array.isArray(row) ? (row[colIndex] !== null ? row[colIndex] : 'NULL') : (row[column.name] !== null ? row[column.name] : 'NULL')"
                                                                    :title="Array.isArray(row) ? row[colIndex] : row[column.name]"></span>
                                                            </template>
                                                        </td>
                                                    </template>
                                                </tr>
                                            </template>
                                            <!-- Extra row for adding data -->
                                            <tr>
                                                <td class="row-number">+</td>
                                                <template x-for="(column, colIndex) in tableColumns" :key="column.name">
                                                    <td style="min-width: 300px;">
                                                        <input
                                                            :type="getInputType(column.constraint ? column.constraint.type : '')"
                                                            class="form-control text-[11px]" :placeholder="column.name"
                                                            x-model="insertRow[column.name]"
                                                            @keydown.enter.stop.prevent="addRow()"
                                                            style="padding:2px 6px;">
                                                    </td>
                                                </template>
                                            </tr>
                                        </tbody>
                                    </table>
                                </template>
                            </div>

                            <!-- Query Panel -->
                            <div x-show="selectedDb && showQueryPanel" class="query-panel">
                                <div class="form-group">
                                    <label>SQL Query</label>
                                    <textarea class="query-editor" x-model="queryText" :placeholder="selectedTable && tableColumns.length > 0
                                    ? `INSERT INTO ${selectedTable} (${tableColumns.map(col => col.name).join(', ')}) VALUES (${tableColumns.map(col => `'${col.name}'`).join(', ')})`
                                    : 'Enter your SQL query here...'
                                "></textarea>
                                </div>
                                <div class="flex gap-2">
                                    <button class="btn btn-primary" @click="executeQuery()"
                                        :disabled="!queryText.trim() || loading">
                                        <i data-lucide="play"></i>
                                        Execute
                                    </button>
                                    <button class="btn btn-secondary" @click="queryText = ''">
                                        Clear
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>

            <!-- script -->
            <script>
                document.addEventListener('DOMContentLoaded', () => {
                    const theme = localStorage.getItem('theme')
                    const html = document.documentElement;
                    html.setAttribute('data-theme', theme);

                    // Update button icon
                    const button = document.querySelector('.theme-toggle');
                    button.textContent = theme === 'dark' ? '🌙' : '☀️';
                })

                // Theme toggle functionality
                function toggleTheme() {
                    const html = document.documentElement;
                    const currentTheme = html.getAttribute('data-theme');
                    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                    html.setAttribute('data-theme', newTheme);

                    // Update button icon
                    const button = document.querySelector('.theme-toggle');
                    button.textContent = newTheme === 'dark' ? '🌙' : '☀️';
                    localStorage.setItem('theme', newTheme)
                }

                // Filter functionality
                document.querySelectorAll('.filter-select, .filter-input').forEach(element => {
                    element.addEventListener('change', function (e) {
                        // Add filter functionality here
                        console.log('Filter changed:', e.target.value);
                    });
                });

                // Add keyboard shortcut for search
                document.addEventListener('keydown', function (e) {
                    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                        e.preventDefault();
                        document.querySelector('.search-input').focus();
                    }
                });

                // Table row click functionality
                document.querySelectorAll('.workspace-table tbody tr').forEach(row => {
                    row.addEventListener('click', function () {
                        console.log('Clicked workspace:', this.querySelector('.workspace-title').textContent);
                        // Add navigation to workspace here
                    });
                });

            </script>
        </div>
    </template>


    <template x-if="isAuthenticated || sharedDb">
        <div>
            <!-- user modal -->
            <template x-if="userModal && user">
                <div class="modal" @click.self="userModal = false">
                    <div class="modal-content" style="width: 420px;">
                        <div class="w-full flex items-center justify-center flex-col gap-1 text-[13px]">
                            <div x-text="user.username.slice(0,2).toUpperCase()"
                                class="flex items-center justify-center cursor-pointer w-[50px] rounded-[50px] bg-[var(--color-primary)] h-[50px] text-[20px] text-white font-semibold">
                            </div>
                            <p class="font-semibold capitalize" style="margin-top: 16px;" x-text="user.username"></p>
                            <p class="text-[var(--color-muted)]" x-text="user.email"></p>
                            <p class="text-[var(--color-muted)]"
                                x-text="user.created_at ? new Date(user.created_at).toLocaleDateString() : ''"></p>
                            <div class="flex flex-col gap-2 w-full" style="margin-top: 16px;">
                                <button type="button" class="w-full btn btn-secondary"
                                    @click="logout(); userModal=false;">Sign
                                    Out</button>
                            </div>
                        </div>
                    </div>
                </div>
            </template>

            <!-- column info -->
            <template x-if="showColumnInfo && selectedDb && tab != null && selectedTable && tableColumns.length > 0">
                <div class="modal" @click.self="showColumnInfo = false">
                    <div class="modal-content" style="min-width: 420px;">
                        <h3 style="margin-bottom: 16px;">Edit Columns for <span class="text-[#2563eb]"
                                x-text="selectedTable"></span></h3>
                        <div class="tab-nav" style="margin-bottom: 12px;">
                            <button class="tab-btn" :class="tab==='editType' ? 'active' : ''"
                                @click="tab='editType'">Add Column</button>
                            <button class="tab-btn" :class="tab==='danger' ? 'active' : ''"
                                @click="tab='danger'">Danger</button>
                        </div>
                        <!-- Edit Type Tab -->
                        <div x-show="tab==='editType'">
                            <h4 style="margin-bottom: 8px;">Add New Column</h4>
                            <form
                                @submit.prevent="addColumn(newColumnName.replace(/\s+/g, '_'), newColumnType, newColumnConstraint); newColumnName=''; newColumnType=''; newColumnConstraint = ''; showColumnInfo=false;">
                                <div class="form-group flex items-center gap-2">
                                    <input type="text" class="form-control w-1/4" placeholder="Column Name"
                                        x-model="newColumnName" required />
                                    <select class="form-control w-1/4" x-model="newColumnType" required>
                                        <option value="">Select Type</option>
                                        <option value="INTEGER DEFAULT 0">INTEGER</option>
                                        <option value="TEXT DEFAULT ''">TEXT</option>
                                        <option value="REAL DEFAULT 0.0">REAL</option>
                                        <option value="BLOB">BLOB</option>
                                        <option value="NUMERIC">NUMERIC</option>
                                        <option value="BOOLEAN DEFAULT FALSE">BOOLEAN</option>
                                        <option value="DATE">DATE</option>
                                        <option value="DATETIME">DATETIME</option>
                                    </select>
                                    <select class="form-control w-1/4" x-model="newColumnConstraint">
                                        <option value="">No Constraint</option>
                                        <option value="PRIMARY KEY">PRIMARY KEY</option>
                                        <option value="UNIQUE">UNIQUE</option>
                                        <option value="NOT NULL">NOT NULL</option>
                                    </select>
                                    <button type="submit" class="btn btn-primary btn-sm"
                                        :disabled="!newColumnName || !newColumnType">Add</button>
                                </div>
                            </form>
                        </div>
                        <!-- Danger Tab -->
                        <div x-show="tab==='danger'">
                            <template x-for="(column, colIndex) in tableColumns" :key="column.name">
                                <div class="form-group flex items-center gap-2">
                                    <label class="w-1/2" x-text="column.name"></label>
                                    <button class="btn btn-danger btn-sm"
                                        @click="deleteColumn({col: column.name}); showColumnInfo=false"
                                        :disabled="tableColumns.length <= 1">
                                        Delete Column
                                    </button>
                                </div>
                            </template>
                            <div class="alert alert-warning mt-2">
                                <strong>Warning:</strong> Deleting a column is irreversible and may result in data loss.
                            </div>
                        </div>
                        <div class="flex gap-2" style="margin-top: 16px;">
                            <button type="button" class="btn btn-secondary"
                                @click="showColumnInfo = false">Close</button>
                        </div>
                    </div>
                </div>
            </template>

            <!-- configuration modal -->
            <template x-if="showConfigModal && selectedDb && tab != null">
                <div class="modal" @click.self="showConfigModal = false">
                    <div class="modal-content" style="min-width: 420px;">
                        <h3 style="margin-bottom: 16px;">Database Configuration</h3>
                        <div>
                            <div class="tab-nav" style="margin-bottom: 12px;">
                                <button class="tab-btn" :class="tab==='info' ? 'active' : ''"
                                    @click="tab='info'">Info</button>
                                <button class="tab-btn" :class="tab==='share' ? 'active' : ''"
                                    @click="tab='share'">Share</button>
                                <button class="tab-btn" x-show="selectedDb.share_token"
                                    :class="tab==='connect' ? 'active' : ''" @click="tab='connect'">Connect</button>
                                <button class="tab-btn" :class="tab==='backup' ? 'active' : ''"
                                    @click="tab='backup'">Backup</button>
                            </div>
                            <!-- Info Tab -->
                            <div x-show="tab==='info'">
                                <div class="form-group">
                                    <label>Database ID</label>
                                    <input type="text" class="form-control" :value="selectedDb.id" readonly>
                                </div>
                                <div class="form-group">
                                    <label>Database Name</label>
                                    <input type="text" class="form-control" :value="selectedDb.name" readonly>
                                </div>
                                <div class="form-group">
                                    <label>Database Owner</label>
                                    <input type="text" class="form-control" :value="selectedDb.username || 'N/A'"
                                        readonly>
                                </div>
                                <div class="form-group">
                                    <label>Created At</label>
                                    <input type="text" class="form-control"
                                        :value="new Date(selectedDb.created_at).toLocaleString()" readonly>
                                </div>
                            </div>
                            <!-- Share Tab -->
                            <div x-show="tab==='share'">
                                <template x-if="selectedDb.share_token">
                                    <div>
                                        <div class="alert alert-success" style="margin-bottom: 8px;">
                                            <span>This database is currently <strong>shared</strong>.</span>
                                        </div>
                                        <div class="form-group">
                                            <label>Share Token</label>
                                            <div @click="navigator.clipboard.writeText(selectedDb.share_token)"
                                                class="flex items-center gap-2 form-control">
                                                <input type="text" class="flex-grow" :value="selectedDb.share_token"
                                                    readonly>
                                                <button type="button" class="cursor-pointer" title="Copy token" @click="navigator.clipboard.writeText(selectedDb.share_token); 
                                                        showTick='copied_token'
                                                        setTimeout(() => { showTick = null; }, 2000);">
                                                    <!-- Tick SVG icon -->
                                                    <div x-show="showTick==='copied_token'">
                                                        ✅
                                                    </div>

                                                    <!-- Copy SVG icon -->
                                                    <svg x-show="showTick===null" width="20" height="20"
                                                        viewBox="0 0 24 24" fill="none"
                                                        xmlns="http://www.w3.org/2000/svg">
                                                        <rect x="4" y="6" width="16" height="12" rx="3" fill="#d1d5db"
                                                            fill-opacity="0.5" />
                                                        <rect x="4" y="6" width="16" height="12" rx="3" stroke="#6b7280"
                                                            stroke-width="1.5" />
                                                        <rect x="8" y="2" width="8" height="16" rx="2" fill="#6b7280"
                                                            fill-opacity="0.2" />
                                                        <rect x="8" y="2" width="8" height="16" rx="2" stroke="#6b7280"
                                                            stroke-width="1.5" />
                                                    </svg>
                                                </button>
                                            </div>
                                            <p class="flex flex-col" style="margin-top: 4px;">
                                                <small class="text-[#888] text-[11px]">Use this token to access the
                                                    database via API.</small>
                                                <small class="text-[11px]">
                                                    <span class="text-[#888]">Expires on:</span> <span
                                                        x-text="new Date(selectedDb.token_expiry).toLocaleString()"></span>
                                                </small>
                                            </p>
                                        </div>
                                        <div class="form-group">
                                            <label>Share Link</label>
                                            <div @click="navigator.clipboard.writeText(window.location.origin + '/api/shared/' + selectedDb.share_token)"
                                                class="flex items-center gap-2 form-control">
                                                <input type="text" class="flex-grow"
                                                    :value="window.location.origin + '/api/shared/' + selectedDb.share_token"
                                                    readonly>
                                                <button type="button" class="cursor-pointer" title="Copy link" @click="navigator.clipboard.writeText(window.location.origin + '/api/shared/' + selectedDb.share_token)
                                                        showTick='copied_share_link'
                                                        setTimeout(() => { showTick = null; }, 2000);
                                                    ">
                                                    <!-- Tick SVG icon -->
                                                    <div x-show="showTick==='copied_share_link'">
                                                        ✅
                                                    </div>

                                                    <!-- Copy SVG icon -->
                                                    <svg x-show="showTick===null" width="20" height="20"
                                                        viewBox="0 0 24 24" fill="none"
                                                        xmlns="http://www.w3.org/2000/svg">
                                                        <rect x="4" y="6" width="16" height="12" rx="3" fill="#d1d5db"
                                                            fill-opacity="0.5" />
                                                        <rect x="4" y="6" width="16" height="12" rx="3" stroke="#6b7280"
                                                            stroke-width="1.5" />
                                                        <rect x="8" y="2" width="8" height="16" rx="2" fill="#6b7280"
                                                            fill-opacity="0.2" />
                                                        <rect x="8" y="2" width="8" height="16" rx="2" stroke="#6b7280"
                                                            stroke-width="1.5" />
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                        <button class="btn btn-primary w-full" style="margin-top: 8px;"
                                            @click="renewShareToken(selectedDb); showConfigModal = false;">
                                            <!-- edit icon -->
                                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"
                                                style="vertical-align: middle; margin-right: 4px;"
                                                xmlns="http://www.w3.org/2000/svg">
                                                <path
                                                    d="M12.8 3.2a1.067 1.067 0 0 1 1.507 1.507l-7.2 7.2-2.4.267.267-2.4 7.2-7.2z"
                                                    stroke="#fff" stroke-width="1.2" fill="none" />
                                                <rect x="2" y="11" width="3" height="1.2" rx="0.6" fill="#fff" />
                                            </svg>
                                            Update Token
                                        </button>
                                        <button
                                            x-show="selectedDb.token_expiry && new Date(selectedDb.token_expiry) < new Date()"
                                            class="btn btn-secondary w-full" style="margin-top: 8px;"
                                            @click="renewTokenExpiry(selectedDb); showConfigModal = false;">
                                            <!-- reload icon -->
                                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"
                                                style="vertical-align: middle; margin-right: 4px;"
                                                xmlns="http://www.w3.org/2000/svg">
                                                <path d="M2 8a6 6 0 1 1 2.47 4.85" stroke="#ffff" stroke-width="1.5"
                                                    fill="none" />
                                                <path d="M2 12v-3h3" stroke="#ffff" stroke-width="1.5" fill="none" />
                                            </svg>
                                            Extend Token Expiry Period
                                        </button>
                                        <button class="btn btn-danger w-full" style="margin-top: 8px;"
                                            @click="shareDatabase(selectedDb); showConfigModal = false;">
                                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"
                                                style="vertical-align: middle;" xmlns="http://www.w3.org/2000/svg">
                                                <rect x="3" y="7" width="10" height="7" rx="2" fill="#fff"
                                                    fill-opacity="0.15" />
                                                <rect x="3" y="7" width="10" height="7" rx="2" stroke="#fff"
                                                    stroke-width="1" />
                                                <rect x="7" y="10" width="2" height="3" rx="1" fill="#fff" />
                                                <path d="M5 7V5a3 3 0 1 1 6 0v2" stroke="#fff" stroke-width="1"
                                                    fill="none" />
                                            </svg>
                                            Unshare Database
                                        </button>
                                    </div>
                                </template>
                                <template x-if="!selectedDb.share_token">
                                    <div>
                                        <div x-show="!sharedToken" class="alert alert-info" style="margin-bottom: 8px;">
                                            <span>This database is <strong>private</strong>.</span>
                                        </div>
                                        <div x-show="sharedToken" class="alert alert-info" style="margin-bottom: 8px;">
                                            <span>Cannot share database, <strong>not allowed</strong>.</span>
                                        </div>
                                        <button class="btn btn-primary w-full" x-show="!sharedToken"
                                            @click="shareDatabase(selectedDb); showConfigModal = false;">
                                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"
                                                style="vertical-align: middle;" xmlns="http://www.w3.org/2000/svg">
                                                <rect x="3" y="7" width="10" height="7" rx="2" fill="#fff"
                                                    fill-opacity="0.15" />
                                                <rect x="3" y="7" width="10" height="7" rx="2" stroke="#fff"
                                                    stroke-width="1" />
                                                <rect x="7" y="10" width="2" height="3" rx="1" fill="#fff" />
                                                <path d="M8 7V5a3 3 0 0 1 6 0" stroke="#fff" stroke-width="1"
                                                    fill="none" />
                                                <circle cx="12" cy="5" r="1" fill="#fff" />
                                            </svg>
                                            Share Database
                                        </button>
                                    </div>
                                </template>
                            </div>
                            <!-- Connect Tab -->
                            <div x-show="selectedDb.share_token &&tab==='connect'">
                                <div class="form-group">
                                    <label>Host name</label>
                                    <div @click="
                                            navigator.clipboard.writeText(window.location.origin);
                                            showTick='copied_connection_link';
                                            setTimeout(() => { showTick = null; }, 2000);
                                        " class="flex items-center gap-2 form-control">
                                        <input type="text" class="flex-grow" :value="window.location.origin" readonly>
                                        <button type="button" class="cursor-pointer" title="Copy link" @click="navigator.clipboard.writeText(window.location.origin);
                                            showTick='copied_connection_link';
                                            setTimeout(() => { showTick = null; }, 2000);
                                        ">
                                            <!-- Tick SVG icon -->
                                            <div x-show="showTick==='copied_connection_link'">
                                                ✅
                                            </div>

                                            <!-- Copy SVG icon -->
                                            <svg x-show="showTick===null" width="20" height="20" viewBox="0 0 24 24"
                                                fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <rect x="4" y="6" width="16" height="12" rx="3" fill="#d1d5db"
                                                    fill-opacity="0.5" />
                                                <rect x="4" y="6" width="16" height="12" rx="3" stroke="#6b7280"
                                                    stroke-width="1.5" />
                                                <rect x="8" y="2" width="8" height="16" rx="2" fill="#6b7280"
                                                    fill-opacity="0.2" />
                                                <rect x="8" y="2" width="8" height="16" rx="2" stroke="#6b7280"
                                                    stroke-width="1.5" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Token</label>
                                    <div @click="
                                            navigator.clipboard.writeText(selectedDb.share_token);
                                            showTick='copied_token';
                                            setTimeout(() => { showTick = null; }, 2000);
                                        " class="flex items-center gap-2 form-control">
                                        <input type="text" class="flex-grow" :value="selectedDb.share_token" readonly>
                                        <button type="button" class="cursor-pointer" title="Copy token" @click="navigator.clipboard.writeText(selectedDb.share_token);
                                            showTick='copied_token';
                                            setTimeout(() => { showTick = null; }, 2000);
                                        ">
                                            <!-- Tick SVG icon -->
                                            <div x-show="showTick==='copied_token'">
                                                ✅
                                            </div>

                                            <!-- Copy SVG icon -->
                                            <svg x-show="showTick===null" width="20" height="20" viewBox="0 0 24 24"
                                                fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <rect x="4" y="6" width="16" height="12" rx="3" fill="#d1d5db"
                                                    fill-opacity="0.5" />
                                                <rect x="4" y="6" width="16" height="12" rx="3" stroke="#6b7280"
                                                    stroke-width="1.5" />
                                                <rect x="8" y="2" width="8" height="16" rx="2" fill="#6b7280"
                                                    fill-opacity="0.2" />
                                                <rect x="8" y="2" width="8" height="16" rx="2" stroke="#6b7280"
                                                    stroke-width="1.5" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Instructions</label>
                                    <div style="font-size: 12px; color: #888;">
                                        <ol style="padding-left: 18px;">
                                            <li>1. Use the Connection link above to access this database
                                                programmatically.</li>
                                            <li>2. For shared databases, use the share token in the URL or via
                                                <code
                                                    x-text="window.location.origin + '/api/shared/&lt;token&gt;'"></code>.
                                            </li>
                                            <li>3. Example: <br />
                                                <div class="form-control"
                                                    @click="navigator.clipboard.writeText(`curl -X POST -H 'Content-Type: application/json' -d '{\'sql\':\'SELECT * FROM mytable\'}' ${window.location.origin}/api/shared/${selectedDb.share_token}/query`)">
                                                    <code
                                                        x-text="`curl -X POST -H 'Content-Type: application/json' -d '{\'sql\':\'SELECT * FROM mytable\'}' ${window.location.origin}/api/shared/${selectedDb.share_token}/query`"></code>
                                                </div>
                                            </li>
                                            <li>4. For more details, see the documentation or contact your
                                                administrator.</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                            <!-- backup -->
                            <div x-show="tab==='backup'">
                                <div class="form-group">
                                    <label>Filename</label>
                                    <input type="text" :placeholder="selectedDb.name" :placeholder="selectedDB.name"
                                        class="form-control" x-model="backup_filename">
                                </div>
                                <div class="form-group">
                                    <label>Format</label>
                                    <div class="w-full">
                                        <select class="format-selector" x-model="backup_format" style="width: 100%;"
                                            id="">
                                            <option value="custom" disabled>Select format</option>
                                            <option value="sqlite">Custom (.sqlite)</option>
                                            <option value="tar">Tar (.tar)</option>
                                            <option value="zip">Directory (.zip)</option>
                                        </select>
                                    </div>
                                </div>
                                <button class="btn btn-success w-full" style="margin-top: 8px;"
                                    @click="backupDB(selectedDb); showConfigModal = false;">
                                    <!-- disk icon -->
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none"
                                        style="vertical-align: middle; margin-right: 4px;"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <rect x="2" y="2" width="12" height="12" rx="2" fill="#2563eb" />
                                        <rect x="4" y="4" width="8" height="6" rx="1" fill="#fff" />
                                        <rect x="6" y="11" width="4" height="2" rx="1" fill="#fff" />
                                    </svg>
                                    Backup Database
                            </div>
                        </div>
                        <div class="flex gap-2" style="margin-top: 16px;">
                            <button type="button" class="btn btn-secondary"
                                @click="showConfigModal = false">Close</button>
                        </div>
                    </div>
                </div>
            </template>

            <!-- delete row modal -->
            <div x-show="showRowDropdown!=null" @click.self="showRowDropdown = null" class="modal">
                <div class="modal-content">
                    <h3 style="margin-bottom: 16px;">You've selected row #<span
                            x-text="showRowDropdown ? showRowDropdown.index + 1 : ''"></span></h3>
                    <button @click="deleteRow(showRowDropdown.row, showRowDropdown.index)"
                        style="padding: 6px 16px; color: white; margin-bottom:8px;"
                        class="btn btn-danger w-full text-left rounded-md cursor-pointer">
                        🗑️ Delete Row
                    </button>
                    <button type="button" class="btn btn-secondary" @click="showRowDropdown = null">Cancel</button>
                </div>
            </div>

            <!-- Delete Database Modal -->
            <div x-show="showDeleteModal" class="modal" @click.self="showDeleteModal = false">
                <div class="modal-content">
                    <h3 style="margin-bottom: 16px;">Are you sure you want to delete the
                        database
                        <strong class="text-[#2563eb]" x-text="selectedDb ? selectedDb.name : ''"></strong>? This action
                        cannot be undone.
                    </h3>
                    <form @submit.prevent="deleteDatabase(selectedDb.id)">
                        <div class="form-group">
                            <label class="text-sm mt-4">Type the database name to
                                confirm</label>
                            <input type="text" class="form-control" x-model="deleteDbName" required
                                placeholder="Enter database name to confirm">
                        </div>
                        <div class="flex gap-2">
                            <button type="submit" class="btn btn-danger"
                                :disabled="deleteDbName !== (selectedDb ? selectedDb.name : '') || loading">
                                <span x-text="loading ? 'Deleting...' : 'Delete'"></span>
                            </button>
                            <button type="button" class="btn btn-secondary"
                                @click="showDeleteModal = false">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Create Database Modal -->
            <div x-show="showCreateModal" class="modal" @click.self="showCreateModal = false">
                <div class="modal-content">
                    <h3 style="margin-bottom: 16px;">Create New Database</h3>
                    <form @submit.prevent="createDatabase()">
                        <div class="form-group">
                            <label>Database Name</label>
                            <input type="text" class="form-control" x-model="newDbName" required
                                placeholder="Enter database name">
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea type="text" class="form-control" x-model="newDbDescription"
                                placeholder="Enter database description"></textarea>
                        </div>
                        <div class="flex gap-2">
                            <button type="submit" class="btn btn-primary" :disabled="!newDbName.trim() || loading">
                                <span x-text="loading ? 'Creating...' : 'Create'"></span>
                            </button>
                            <button type="button" class="btn btn-secondary"
                                @click="showCreateModal = false">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Create Table Modal -->
            <div x-show="showTableModal && selectedDb" class="modal" @click.self="showTableModal = false">
                <div class="modal-content">
                    <h3 style="margin-bottom: 16px;">Create New Table</h3>
                    <form @submit.prevent="createTable(); showTableModal = false; resetTableForm();">
                        <div class="form-group">
                            <label>Table Name</label>
                            <input type="text" class="form-control" x-model="newTableForm.name" required
                                placeholder="Enter table name">
                        </div>
                        <div class="form-group">
                            <div class="form-group flex flex-col gap-2">
                                <div class="flex gap-2">
                                    <input type="text" class="form-control w-1/3" placeholder="Column Name"
                                        x-model="newColumnName" />
                                    <select class="form-control w-1/3" x-model="newColumnType">
                                        <option value="">Select Type</option>
                                        <option value="INTEGER">INTEGER</option>
                                        <option value="TEXT">TEXT</option>
                                        <option value="REAL">REAL</option>
                                        <option value="BLOB">BLOB</option>
                                        <option value="NUMERIC">NUMERIC</option>
                                        <option value="BOOLEAN">BOOLEAN</option>
                                        <option value="DATE">DATE</option>
                                        <option value="DATETIME">DATETIME</option>
                                    </select>
                                    <select class="form-control w-1/3" x-model="newColumnConstraint">
                                        <option value="">No Constraint</option>
                                        <option value="PRIMARY KEY">PRIMARY KEY</option>
                                        <option value="UNIQUE">UNIQUE</option>
                                        <option value="NOT NULL">NOT NULL</option>
                                        <option value="DEFAULT 0">DEFAULT 0</option>
                                        <option value="DEFAULT ''">DEFAULT ''</option>
                                    </select>
                                    <button type="button" class="btn btn-primary btn-sm"
                                        :disabled="!newColumnName || !newColumnType" @click="
                                            if (!newTableForm.columnsArr) newTableForm.columnsArr = [];
                                            newTableForm.columnsArr.push({
                                                name: newColumnName.replace(/\s+/g, '_'),
                                                type: newColumnType,
                                                constraint: newColumnConstraint || ''
                                            });
                                            newTableForm.columns = newTableForm.columnsArr.map(col => 
                                                `${col.name} ${col.type}${col.constraint ? ' ' + col.constraint : ''}`
                                            ).join(', ');
                                            newColumnName = '';
                                            newColumnType = '';
                                            newColumnConstraint = '';
                                        ">
                                        Add
                                    </button>
                                </div>
                                <div class="mt-2">
                                    <label>Columns (SQL format)</label>
                                    <textarea class="form-control" rows="3" readonly x-model="newTableForm.columns"
                                        placeholder="id INTEGER PRIMARY KEY, name TEXT NOT NULL, email TEXT UNIQUE"></textarea>
                                </div>
                                <template x-if="newTableForm.columnsArr && newTableForm.columnsArr.length">
                                    <div class="mt-2">
                                        <ul class="gap-2 flex flex-col">
                                            <template x-for="(col, idx) in newTableForm.columnsArr" :key="idx">
                                                <li class="flex justify-between w-full items-center gap-2">
                                                    <span
                                                        x-text="`${col.name} ${col.type}${col.constraint ? ' ' + col.constraint : ''}`"></span>
                                                    <button type="button" class="btn btn-danger btn-xs" @click="
                                                            newTableForm.columnsArr.splice(idx, 1);
                                                            newTableForm.columns = newTableForm.columnsArr.map(col => 
                                                                `${col.name} ${col.type}${col.constraint ? ' ' + col.constraint : ''}`
                                                            ).join(', ');
                                                        ">
                                                        Remove
                                                    </button>
                                                </li>
                                            </template>
                                        </ul>
                                    </div>
                                </template>
                                <small style="color: #888; font-size: 11px;">Example: id INTEGER PRIMARY KEY, name TEXT
                                    NOT
                                    NULL,
                                    email TEXT</small>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button type="submit" class="btn btn-primary"
                                :disabled="!newTableForm.name.trim() || !newTableForm.columns.trim() || loading">
                                <span x-text="loading ? 'Creating...' : 'Create Table'"></span>
                            </button>
                            <button type="button" class="btn btn-secondary"
                                @click="showTableModal = false; resetTableForm()">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Insert Data Modal -->
            <div x-show="showInsertModal && selectedTable && selectedDb" class="modal"
                @click.self="showInsertModal = false">
                <div class="modal-content">
                    <h3 style="margin-bottom: 16px;">Insert Data into <span class="text-blue-500"
                            x-text="selectedTable"></span></h3>
                    <form @submit.prevent="insertData()">
                        <template x-for="(column, index) in tableColumns" :key="column.name">
                            <div class="form-group">
                                <label x-text="column.name + (column.constraint.not_null ? ' *' : '')"></label>
                                <input class="form-control" x-model="insertForm.data[column.name]"
                                    :type="getInputType(column.constraint ? column.constraint.type : '')"
                                    :placeholder="`Enter ${column.name}`"
                                    :required="column.constraint.not_null && column.constraint.default !== null" />
                            </div>
                        </template>

                        <div class="flex gap-2">
                            <button type="submit" class="btn btn-success" :disabled="loading">
                                <span x-text="loading ? 'Inserting...' : 'Insert Data'"></span>
                            </button>
                            <button type="button" class="btn btn-secondary"
                                @click="showInsertModal = false; resetInsertForm()">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Delete Table Modal -->
            <div x-show="showDeleteTableModal" class="modal" @click.self="showDeleteTableModal = false">
                <div class="modal-content">
                    <h3 style="margin-bottom: 16px;">Are you sure you want to delete table
                        <strong class="text-[#2563eb]" x-text="selectedTable? selectedTable : ''"></strong>?
                    </h3>

                    <div class="flex gap-2">
                        <button @click="deleteTable" class="btn btn-danger" :disabled="loading">
                            <span x-text="loading ? 'Deleting...' : 'Delete'"></span>
                        </button>
                        <button type="button" class="btn btn-secondary"
                            @click="showDeleteTableModal = false">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <script>
        function sqlitePanel() {
            return {
                // Authentication state
                isAuthenticated: false,
                authMode: 'login',
                page: 'database',
                user: null,
                authFormRegister: { username: '', password: '', email: '' },
                authFormLogin: { username: '', password: '' },
                authFormForgot: { email: '', otp: null, new_password: '', confirm_password: '' },

                // UI state
                loading: false,
                screenLoading: false,
                message: { text: '', type: '' },
                tab: null,
                newColumnName: null, newColumnType: null, newColumnConstraint: null,
                showTick: null,
                showEnterOTPInput: false,
                verificationOTP: null,

                // Database state
                searchQuery: null,
                databases: [],
                selectedDb: null,
                tables: [],
                selectedTable: null,
                tableData: [],
                tableColumns: [],
                filterText: '',
                editingCell: null,
                selectedRow: null,
                index: 0,

                // Modals
                showCreateModal: false,
                showTableModal: false,
                showInsertModal: false,
                showDeleteModal: false,
                showDeleteTableModal: false,
                deleteDbName: '',
                sharedDbName: '',
                showRowDropdown: null,
                showDeleteRowModal: { show: false, row: null, index: null },
                showEditRowModal: false,
                selectShowDeleteRowIcon: null,
                showConfigModal: false,
                showColumnInfo: false,
                showQueryPanel: false,
                userModal: false,

                // Forms
                newDbName: '',
                newDbDescription: '',
                newTableForm: { name: '', columns: '' },
                insertForm: { data: {} },
                backup_filename: '',
                backup_format: '',

                // Query state
                queryText: '',
                queryResults: null,

                insertRow: {},

                // Shared database state
                sharedToken: localStorage.getItem('sharedToken') || '',
                sharedDb: null,

                init() {
                    this.checkAuth();
                },

                // Utility methods
                setMessage(text, type = 'success') {
                    this.message = { text, type };
                    setTimeout(() => {
                        this.message = { text: '', type: '' };
                    }, 5000);
                },

                async apiCall(url, options = {}) {
                    try {
                        const response = await fetch(url, {
                            credentials: 'include',
                            headers: {
                                'Content-Type': 'application/json',
                                ...options.headers
                            },
                            ...options
                        });

                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(errorText || `HTTP ${response.status}`);
                        }

                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            return await response.json();
                        }
                        return null;
                    } catch (error) {
                        throw error;
                    }
                },

                // Authentication methods
                async checkAuth() {
                    this.screenLoading = true
                    try {
                        if (this.sharedToken) {
                            this.isAuthenticated = true
                        } else {
                            const result = await this.apiCall('/api/authenticate');
                            this.user = result?.data.user || null;
                            this.isAuthenticated = result?.data.authenticated || false;
                        }
                        if (this.isAuthenticated) {
                            this.loadDatabases();
                        }
                    } catch (error) {
                        this.isAuthenticated = false;
                        this.user = null;
                    }
                    this.screenLoading = false
                },

                async register() {
                    if (!this.authFormRegister.username.trim() || !this.authFormRegister.password.trim() || !this.authFormRegister.email.trim()) return;

                    this.loading = true;
                    try {
                        await this.apiCall('/api/register', {
                            method: 'POST',
                            body: JSON.stringify(this.authFormRegister)
                        });
                        this.setMessage('Registration successful! Please login.', 'success');
                        this.authMode = 'login';
                        this.authFormRegister = { username: '', password: '', email: '' };
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                    this.loading = false;
                },

                async login() {
                    if (!this.authFormLogin.username.trim() || !this.authFormLogin.password.trim()) return;

                    this.loading = true;
                    try {
                        const result = await this.apiCall('/api/login', {
                            method: 'POST',
                            body: JSON.stringify(this.authFormLogin)
                        });

                        this.isAuthenticated = true;
                        this.user = result?.data || null;
                        this.setMessage('Login successful!', 'success');
                        this.loadDatabases();
                        this.authFormLogin = { username: '', password: '' };
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                    this.loading = false;
                },

                async verify() {
                    if (!this.authFormForgot.email.trim()) return;
                    this.loading = true;
                    try {
                        const result = await this.apiCall('/api/verify', {
                            method: 'POST',
                            body: JSON.stringify({
                                email: this.authFormForgot.email,
                            })
                        });
                        if (result && result.otp) {
                            this.setMessage('OTP sent to your email!', 'success');
                            this.showEnterOTPInput = true;
                            this.verificationOTP = result.otp
                        } else {
                            this.setMessage('Failed to send OTP. Please try again.', 'error');
                        }
                    } catch (error) {
                        this.setMessage(error.message, 'error');

                    } finally {
                        this.loading = false;
                    }
                },

                verifyOTP() {
                    if (!this.authFormForgot.otp.trim() || !this.verificationOTP.trim()) {
                        this.setMessage('Please enter the OTP sent to your email.', 'error');
                        return
                    };
                    if (this.authFormForgot.otp !== this.verificationOTP) {
                        this.setMessage('Invalid OTP. Please try again.', 'error');
                        return
                    };
                    this.setMessage('OTP verified successfully!', 'success');
                    this.showEnterOTPInput = false;
                },

                async password_reset() {
                    if (!this.authFormForgot.new_password.trim() || !this.authFormForgot.confirm_password.trim()) {
                        this.setMessage('Please fill all fields.', 'error');
                        return
                    };
                    if (this.authFormForgot.new_password !== this.authFormForgot.confirm_password) {
                        this.setMessage('Passwords do not match. Please try again.', 'error');
                        return
                    };
                    this.loading = true;
                    try {
                        const result = await this.apiCall('/api/password_reset', {
                            method: 'PATCH',
                            body: JSON.stringify({
                                email: this.authFormForgot.email,
                                new_password: this.authFormForgot.new_password
                            })
                        });
                        if (result && result.success) {
                            this.setMessage('Password reset successful! Please login.', 'success');
                            this.authMode = 'login';
                            this.authFormForgot = { email: '', otp: '', new_password: '', confirm_password: '' };
                        } else {
                            this.setMessage('Failed to reset password. Please try again.', 'error');
                        }
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    } finally {
                        this.loading = false;
                    }
                },

                async logout() {
                    try {
                        this.sharedToken ? localStorage.removeItem("sharedToken") : await this.apiCall('/api/logout', { method: 'POST' });
                        this.isAuthenticated = false;
                        this.user = null;
                        this.sharedToken = '';
                        this.sharedDb = null;
                        this.databases = [];
                        this.selectedDb = null;
                        this.queryResults = null;
                        this.setMessage('Logged out successfully', 'success');
                        // window.location.reload()
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                },

                // Database management methods
                async loadDatabases() {
                    try {
                        if (this.sharedToken) {
                            // Load shared database if token is set
                            const result = await this.apiCall(`/api/shared/${this.sharedToken}`);
                            this.sharedDb = result.data.database;
                            this.selectedDb = result.data.database;
                            this.tables = [];
                            this.selectedTable = null;
                            this.tableData = [];
                            this.tableColumns = [];

                            if (this.sharedDb) {
                                this.selectedDb = this.sharedDb;;
                                const tablesResult = await this.apiCall(`/api/databases/${this.selectedDb.id}/tables?share_token=${this.sharedToken}`);
                                this.tables = tablesResult.data || [];
                            } else {
                                this.setMessage('Invalid or expired share token', 'error');
                            }
                            return;
                        } else {
                            const result = await this.apiCall('/api/databases');
                            this.databases = result.data || [];
                        }
                    } catch (error) {
                        this.setMessage('Failed to load databases', 'error');
                        this.isAuthenticated = false;
                        this.user = null;
                        this.sharedToken = '';
                        this.sharedDb = null;
                        this.databases = [];
                        this.selectedDb = null;
                        this.queryResults = null;
                    }
                },

                async createDatabase() {
                    if (!this.newDbName.trim()) return;

                    this.loading = true;
                    try {
                        const result = await this.apiCall('/api/databases', {
                            method: 'POST',
                            body: JSON.stringify({ name: this.newDbName, description: this.newDbDescription })
                        });

                        this.newDbName = '';
                        this.showCreateModal = false;
                        await this.loadDatabases();
                        this.selectedDb = result.data;
                        this.tables = [];
                        this.selectedTable = null;
                        this.tableData = [];
                        this.tableColumns = [];
                        this.queryResults = null;
                        this.setMessage('Database created successfully!', 'success');
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                    this.loading = false;
                },

                async deleteDatabase(id) {
                    try {
                        if (!id || !this.selectedDb) return;
                        if (this.deleteDbName !== this.selectedDb.name) {
                            this.setMessage('Please enter the correct database name to confirm deletion.', 'error');
                            return;
                        }
                        this.loading = true;

                        await this.apiCall(`/api/databases/${id}`, { method: 'DELETE' });
                        this.loadDatabases();
                        if (this.selectedDb && this.selectedDb.id === id) {
                            this.selectedDb = null;
                            this.queryResults = null;
                            this.showDeleteModal = false;
                            this.deleteDbName = '';
                        }
                        this.setMessage('Database deleted successfully', 'success');
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                    this.loading = false;
                },

                searchDatabases() {
                    console.log(this.searchQuery)
                },

                async shareDatabase(database) {
                    try {
                        if (database.share_token) {
                            // Disable sharing
                            await this.apiCall(`/api/databases/${database.id}/share`, { method: 'DELETE' });
                            this.selectedDb.share_token = '';
                            this.selectedDb.token_expiry = '';
                            this.setMessage('Database sharing disabled', 'success');
                        } else {
                            // Enable sharing
                            const result = await this.apiCall(`/api/databases/${database.id}/share`, { method: 'POST' });
                            this.selectedDb.share_token = result.data.share_token;
                            this.selectedDb.token_expiry = result.data.token_expiry;
                            this.setMessage(`Database shared! Token: ${result.data.share_token}`, 'success');
                        }
                        this.loadDatabases();
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                },

                async renewTokenExpiry(database) {
                    try {
                        if (!database || !database.id) return;
                        this.loading = true;

                        const result = await this.apiCall(`/api/databases/${database.id}/share/renew`, { method: 'PATCH' });
                        this.selectedDb.share_token = result.data.share_token;
                        this.selectedDb.token_expiry = result.data.token_expiry;
                        this.setMessage('Share token expiry period renewed successfully!', 'success');
                        this.loadDatabases();
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                    this.loading = false;
                },

                async renewShareToken(database) {
                    try {
                        if (!database || !database.id) return;
                        this.loading = true;

                        const result = await this.apiCall(`/api/databases/${database.id}/share/renew`, { method: 'POST' });
                        this.selectedDb.share_token = result.data.share_token;
                        this.selectedDb.token_expiry = result.data.token_expiry;
                        this.setMessage('Share token updated successfully!', 'success');
                        this.loadDatabases();
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                    this.loading = false;
                },

                async selectDatabase(database) {
                    this.selectedDb = database;
                    this.selectedTable = null;
                    this.tables = [];
                    this.tableData = [];
                    this.tableColumns = [];
                    this.queryResults = null;
                    this.queryText = '';
                    this.loading = true;
                    try {
                        const result = !this.sharedToken ? await this.apiCall(`/api/databases/${database.id}/tables`) : await this.apiCall(`/api/databases/${database.id}/tables?share_token=${this.sharedToken}`);
                        this.tables = result.data || [];
                    } catch (error) {
                        this.setMessage('Failed to load tables', 'error');
                    }
                    this.loading = false;
                },

                async addRow() {
                    // Check if all required fields in insertRow are filled
                    if (!this.selectedTable || !this.selectedDb || !this.tableColumns.length) return;
                    const values = this.tableColumns.map(col => this.insertRow[col.name]);
                    if (values.some(v => v === undefined || v === null || v === "")) return;
                    this.loading = true;

                    try {
                        let url = `/api/databases/${this.selectedDb.id}/data`;
                        if (this.sharedToken) {
                            url += `?share_token=${this.sharedToken}`;
                        }
                        await this.apiCall(url, {
                            method: 'POST',
                            body: JSON.stringify({
                                table: this.selectedTable,
                                columns: this.tableColumns.map(col => col.name).join(', '),
                                values: values.map(v => typeof v === 'string' ? `'${v}'` : v).join(', ')
                            })
                        });
                        // Clear insertRow fields
                        this.insertRow = {};
                        // Reload table data
                        await this.selectTable(this.selectedTable);
                        this.setMessage('Row added successfully!', 'success');
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                    this.loading = false;
                },

                async deleteRow(selectedRow, index) {
                    if (!this.selectedDb || !this.selectedTable) return;
                    // Build condition using all columns to uniquely identify the row
                    const condition = {};
                    this.tableColumns.forEach((col, i) => {
                        condition[col.name] = Array.isArray(selectedRow) ? selectedRow[i] : selectedRow[col.name];
                    });

                    this.loading = true;
                    try {
                        let url = `/api/databases/${this.selectedDb.id}/tables/${this.selectedTable}/data`;
                        if (this.sharedToken) {
                            url += `?share_token=${this.sharedToken}`;
                        }
                        await this.apiCall(url, {
                            method: 'DELETE',
                            body: JSON.stringify({ condition })
                        });
                        // Reload table data
                        await this.selectTable(this.selectedTable);
                        this.setMessage('Row deleted successfully!', 'success');
                        this.showRowDropdown = null;
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                    this.loading = false;
                },

                // Query execution methods
                async executeQuery() {
                    if (!this.queryText.trim() || !this.selectedDb) return;

                    this.loading = true;
                    try {
                        let url = `/api/databases/${this.selectedDb.id}/query`;
                        if (this.sharedToken) {
                            url += `?share_token=${this.sharedToken}`;
                        }
                        const result = await this.apiCall(url, {
                            method: 'POST',
                            body: JSON.stringify({ sql: this.queryText })
                        });
                        // Optionally handle query results here
                        this.setMessage('Query executed successfully!', 'success');

                        // Reload tables after creation
                        url = `/api/databases/${this.selectedDb.id}/tables`;
                        if (this.sharedToken) {
                            url += `?share_token=${this.sharedToken}`;
                        }
                        const results = await this.apiCall(url);
                        this.tables = results.data || [];

                        // Optionally reload table data if needed
                        const firstQuery = this.queryText.trim().split(" ")
                        const table = firstQuery[0].toUpperCase() !== "DROP" ? this.selectedTable : this.tables[0]
                        if (table) {
                            this.queryText = ""
                            await this.selectTable(table);
                        }
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                    this.loading = false;
                },

                // Table management methods
                async createTable() {
                    if (!this.newTableForm.name.trim() || !this.newTableForm.columns.trim() || !this.selectedDb) return;

                    this.loading = true;
                    try {
                        let url = `/api/databases/${this.selectedDb.id}/tables`;
                        if (this.sharedToken) {
                            url += `?share_token=${this.sharedToken}`;
                        }
                        await this.apiCall(url, {
                            method: 'POST',
                            body: JSON.stringify({
                                name: this.newTableForm.name,
                                columns: this.newTableForm.columns
                            })
                        });

                        this.showTableModal = false;
                        this.resetTableForm();
                        // Reload tables after creation
                        const result = await this.apiCall(url);
                        this.tables = result.data || [];
                        this.setMessage('Table created successfully!', 'success');
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                    this.loading = false;
                },

                async deleteTable() {
                    const tableName = this.selectedTable
                    this.loading = true;
                    try {
                        await this.apiCall(`/api/databases/${this.selectedDb.id}/tables/${tableName}`, { method: 'DELETE' });
                        // Reload tables after deletion
                        const result = await this.apiCall(`/api/databases/${this.selectedDb.id}/tables`);
                        this.tables = result.data || [];
                        if (this.selectedTable) {
                            this.selectedTable = null;
                            this.tableData = [];
                            this.tableColumns = [];
                            this.showDeleteTableModal = false
                        }
                        this.setMessage('Table deleted successfully!', 'success');
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                    this.loading = false;
                },

                // Data insertion methods
                async insertData() {
                    if (!this.selectedTable || !this.selectedDb || !this.tableColumns.length) {
                        this.setMessage('Please fill all fields before inserting data.', 'error');
                        return;
                    };

                    const values = this.tableColumns.map(col => this.insertForm.data[col.name]);
                    if (values.some(v => v === undefined || v === null || v === "")) {
                        this.setMessage('Please fill before inserting data.', 'error');
                        return;
                    };

                    this.loading = true;
                    try {
                        let url = `/api/databases/${this.selectedDb.id}/data`;
                        if (this.sharedToken) {
                            url += `?share_token=${this.sharedToken}`;
                        }
                        await this.apiCall(url, {
                            method: 'POST',
                            body: JSON.stringify({
                                table: this.selectedTable.trim(),
                                columns: this.tableColumns.map(col => col.name).join(", "),
                                values: values.map(v => typeof v === 'string' ? `'${v}'` : v).join(', ')
                            })
                        });

                        this.showInsertModal = false;
                        this.resetInsertForm();
                        if (this.selectedTable) {
                            await this.selectTable(this.selectedTable);
                        }
                        this.setMessage('Data inserted successfully!', 'success');
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                    this.loading = false;
                },

                // Shared database methods
                async accessSharedDatabase() {
                    if (!this.sharedToken.trim()) return;

                    this.loading = true;
                    try {
                        const result = await this.apiCall(`/api/shared/${this.sharedToken}`);
                        this.sharedDb = result.data.database;
                        this.selectedDb = result.data.database;
                        this.tables = [];
                        this.selectedTable = null;
                        this.tableData = [];
                        this.tableColumns = [];
                        if (!this.sharedDb) {
                            this.setMessage('Invalid or expired share token', 'error');
                            this.sharedToken = '';
                            localStorage.removeItem('sharedToken');
                            this.isAuthenticated = false
                            return;
                        } else {
                            // Load tables for shared database
                            const tablesResult = await this.apiCall(`/api/databases/${this.selectedDb.id}/tables?share_token=${this.sharedToken}`);
                            this.tables = tablesResult.data || [];
                            this.setMessage('Shared database accessed successfully!', 'success');
                            localStorage.setItem('sharedToken', this.sharedToken);
                            this.isAuthenticated = true;
                        }
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                    this.loading = false;
                },

                // Table selection and data loading
                async selectTable(table) {
                    this.selectedTable = table;
                    this.tableData = [];
                    this.tableColumns = [];
                    this.loading = true;
                    try {
                        const result = this.sharedToken ?
                            await this.apiCall(`/api/databases/${this.selectedDb.id}/tables/${table}/data?share_token=${this.sharedToken}`) :
                            await this.apiCall(`/api/databases/${this.selectedDb.id}/tables/${table}/data`);
                        this.tableData = result.data.values || [];
                        this.tableColumns = result.data.columns || [];
                    } catch (error) {
                        this.setMessage('Failed to load table data', 'error');
                        this.isAuthenticated = false;
                        this.user = null;
                        this.sharedToken = '';
                        this.sharedDb = null;
                        this.databases = [];
                        this.selectedDb = null;
                        this.queryResults = null;
                    }
                    this.loading = false;
                },

                //update table cell
                async updateCell(index, column, newValue, oldValue) {
                    if (!this.selectedDb || !this.selectedTable) return;
                    // Find the row to update
                    const row = this.filteredTableData[index];
                    if (!row) return;

                    // Build condition (use all columns as condition for now)
                    const condition = {};
                    this.tableColumns.forEach((col, i) => {
                        // Use value from row (array or object)
                        condition[col.name] = Array.isArray(row) ? row[i] : row[col.name];
                    });

                    // Only update the changed column
                    const data = {};
                    data[column] = newValue;

                    // If oldValue is undefined or null, try to use the value from the row
                    let oldVal = oldValue;
                    if (oldVal === undefined || oldVal === null) {
                        const colIndex = this.tableColumns.findIndex(col => col.name === column);
                        oldVal = Array.isArray(row) ? row[colIndex] : row[column];
                    }

                    // If oldVal is still null/undefined, set to empty string
                    if (oldVal === undefined || oldVal === null) oldVal = '';

                    this.loading = true;
                    try {
                        let url = `/api/databases/${this.selectedDb.id}/tables/${this.selectedTable}/data`;
                        if (this.sharedToken) {
                            url += `?share_token=${this.sharedToken}`;
                        }
                        await this.apiCall(url, {
                            method: 'PUT',
                            body: JSON.stringify({
                                condition,
                                data,
                                oldValue: oldVal
                            })
                        });
                        // Reload table data
                        await this.selectTable(this.selectedTable);
                        this.setMessage('Cell updated successfully!', 'success');
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                    this.loading = false;
                },

                // Helper to get input type based on column type
                getInputType(type) {
                    if (!type) return 'text';
                    const t = type.toLowerCase();
                    if (t.includes('int') || t.includes('real')) return 'number';
                    if (t.includes('date')) return 'date';
                    if (t.includes('bool')) return 'checkbox';
                    return 'text';
                },

                async addColumn(columnName, columnType, newColumnConstraint) {
                    if (!this.selectedDb || !this.selectedTable) return;

                    this.loading = true;
                    try {
                        let url = `/api/databases/${this.selectedDb.id}/query`;
                        if (this.sharedToken) {
                            url += `?share_token=${this.sharedToken}`;
                        }
                        const sql = newColumnConstraint ? `ALTER TABLE "${this.selectedTable}" ADD COLUMN "${columnName.trim()}" ${columnType.trim()} ${newColumnConstraint}` : `ALTER TABLE "${this.selectedTable}" ADD COLUMN "${columnName.trim()}" ${columnType.trim()}`;
                        await this.apiCall(url, {
                            method: 'POST',
                            body: JSON.stringify({ sql })
                        });
                        await this.selectTable(this.selectedTable);
                        this.setMessage('Column added successfully!', 'success');
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                    this.loading = false;
                },

                async deleteColumn(editingCell) {
                    if (!this.selectedDb || !this.selectedTable) return;
                    const columnName = editingCell.col;
                    if (!columnName) {
                        this.setMessage('Column name is required.', 'error');
                        return;
                    }
                    this.loading = true;
                    try {
                        let url = `/api/databases/${this.selectedDb.id}/query`;
                        if (this.sharedToken) {
                            url += `?share_token=${this.sharedToken}`;
                        }
                        // Use SQL query to drop the column
                        const sql = `ALTER TABLE "${this.selectedTable}" DROP COLUMN "${columnName}"`;
                        await this.apiCall(url, {
                            method: 'POST',
                            body: JSON.stringify({ sql })
                        });
                        // Reload table data
                        await this.selectTable(this.selectedTable);
                        this.setMessage('Column deleted successfully!', 'success');
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                    this.loading = false;
                },

                async updateColumnName(editingCell) {
                    if (!this.selectedDb || !this.selectedTable) return;
                    const columnName = editingCell.col;
                    const newColumnName = editingCell.value;
                    if (!columnName || !newColumnName) {
                        this.setMessage('Old and new column are required.', 'error');
                        return;
                    }
                    this.loading = true;
                    try {
                        let url = `/api/databases/${this.selectedDb.id}/query`;
                        if (this.sharedToken) {
                            url += `?share_token=${this.sharedToken}`;
                        }
                        const sql = `ALTER TABLE "${this.selectedTable}" RENAME ${columnName.trim()} TO ${newColumnName.trim()}`;
                        await this.apiCall(url, {
                            method: 'POST',
                            body: JSON.stringify({ sql })
                        });
                        await this.selectTable(this.selectedTable);
                        this.setMessage('Column name changed successfully!', 'success');
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                    this.loading = false;
                },

                async backupDB(selectedDB) {
                    if (!selectedDB || !this.backup_filename || !this.backup_format) return;
                    this.loading = true;
                    try {
                        const response = await fetch(`/api/databases/${selectedDB.id}/backup`, {
                            method: 'POST',
                            credentials: 'include',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                filename: this.backup_filename,
                                format: this.backup_format
                            })
                        });
                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(errorText || `HTTP ${response.status}`);
                        }
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = this.backup_filename;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                        window.URL.revokeObjectURL(url);
                        this.setMessage('Backup downloaded successfully!', 'success');
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                    this.loading = false;
                },

                // Filtered table data
                get filteredTableData() {
                    if (!this.filterText.trim()) return this.tableData;
                    const filter = this.filterText.toLowerCase();
                    return this.tableData.filter(row =>
                        Object.values(row).some(
                            val => val !== null && String(val).toLowerCase().includes(filter)
                        )
                    );
                },

                // Form reset methods
                resetTableForm() {
                    this.newTableForm = { name: '', columns: '' };
                },

                resetInsertForm() {
                    this.insertForm = { table: '', columns: '', values: '' };
                }
            }
        }
    </script>
</body>

</html>