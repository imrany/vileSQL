<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ .Title }}</title>
    <meta http-equiv="X-UA-Compatible" content="IE=7">
    <meta name="description"
        content="Host and manage your SQLite databases in the cloud with unparalleled speed and simplicity">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="keywords" content="SQLite, SQL, databases, cloud, hosting, edge computing">
    <link rel="shortcut icon" href="/static/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="/static/style.css">
    <link rel="apple-touch-icon" href="/static/favicon.png">
    <script defer src="/static/tailwindcss.js"></script>
    <script defer src="/static/alpine.js"></script>
    <script defer src="/static/themeManager.js"></script>
</head>

<body x-data="sqlitePanel()" x-init="init()">
    <!-- loading Screen -->
    <template x-if="screenLoading">
        <div class="screen-loading-overlay">
            <div class="spinner"></div>
        </div>
    </template>

    <!-- Theme Selector UI -->
    <div style="position: fixed; top: 12px; right: 12px; z-index: 100;">
        <div class="theme-controls">
            <select class="theme-selector" id="themeSelector">
                <option value="auto">üåì Auto (System)</option>
                <option value="dark">üåô Dark</option>
                <option value="light">‚òÄÔ∏è Light</option>
            </select>
            <div class="theme-status" id="themeStatus">
                <span class="theme-icon">üåì</span>
                <span id="currentTheme">Auto</span>
            </div>
        </div>
        <div style="font-size: 11px; color: #aaa; margin-top: 2px;">
            <span id="activeTheme">Auto (dark mode active)</span> | System: <span id="systemPreference">Dark</span>
        </div>
    </div>


    <!-- Authentication Screen -->
    <template x-if="!isAuthenticated && !sharedDb">
        <div class="auth-container">
            <div class="card">
                <div class="header">
                    <h1>
                        <i data-lucide="database"></i>
                        VileSQL
                    </h1>
                </div>

                <div style="padding: 20px;">
                    <div x-show="message.text" class="alert"
                        :class="message.type === 'error' ? 'alert-error' : 'alert-success'">
                        <span x-text="message.text"></span>
                    </div>

                    <div class="tab-nav">
                        <button class="tab-btn" :class="authMode === 'login' ? 'active' : ''"
                            @click="authMode = 'login'">
                            Login
                        </button>
                        <button class="tab-btn" :class="authMode === 'register' ? 'active' : ''"
                            @click="authMode = 'register'">
                            Register
                        </button>
                    </div>

                    <form @submit.prevent="authMode === 'login' ? login() : register()" style="padding: 20px 0;">
                        <template x-if="authMode === 'login'">
                            <div>
                                <div class="form-group">
                                    <label>Username</label>
                                    <input type="text" class="form-control" x-model="authFormLogin.username" required>
                                </div>
                                <div class="form-group">
                                    <label>Password</label>
                                    <input type="password" class="form-control" x-model="authFormLogin.password"
                                        required>
                                </div>
                            </div>
                        </template>
                        <template x-if="authMode === 'register'">
                            <div>
                                <div class="form-group">
                                    <label>Username</label>
                                    <input type="text" class="form-control" x-model="authFormRegister.username"
                                        required>
                                </div>
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email" class="form-control" x-model="authFormRegister.email" required>
                                </div>
                                <div class="form-group">
                                    <label>Password</label>
                                    <input type="password" class="form-control" x-model="authFormRegister.password"
                                        required>
                                </div>
                            </div>
                        </template>
                        <button type="submit" class="btn btn-primary" style="width: 100%;" :disabled="loading">
                            <template x-if="loading">
                                <div class="spinner" style="width: 16px; height: 16px;"></div>
                            </template>
                            <span
                                x-text="loading ? 'Processing...' : (authMode === 'login' ? 'Login' : 'Register')"></span>
                        </button>
                    </form>

                    <div style="border-top: 1px solid #444; padding-top: 16px;">
                        <div class="section-header">Access Shared Database</div>
                        <div class="flex gap-2">
                            <input type="text" class="form-control" x-model="sharedToken"
                                placeholder="Enter share token">
                            <button class="btn btn-secondary" @click="accessSharedDatabase()" :disabled="!sharedToken">
                                <!-- share svg -->
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" style="vertical-align: middle; margin-right: 4px;" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="12" cy="4" r="2" fill="#ffff"/>
                                    <circle cx="4" cy="8" r="2" fill="#ffff"/>
                                    <circle cx="12" cy="12" r="2" fill="#ffff"/>
                                    <line x1="5.7" y1="8.7" x2="10.3" y2="11.3" stroke="#ffff" stroke-width="1.2"/>
                                    <line x1="10.3" y1="4.7" x2="5.7" y2="7.3" stroke="#ffff" stroke-width="1.2"/>
                                </svg>
                                Access
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- Main Application -->
    <template x-if="isAuthenticated || sharedDb">
        <div class="container">
            <div class="card">
                <div class="header">
                    <h1>
                        <!-- database icon -->
                        <svg width="26" height="26" viewBox="0 0 20 20" fill="none" style="flex-shrink:0;"
                            xmlns="http://www.w3.org/2000/svg">
                            <ellipse cx="10" cy="5" rx="8" ry="3" fill="#ec4899" />
                            <ellipse cx="10" cy="10" rx="8" ry="3" fill="#ec4899" fill-opacity="0.8" />
                            <ellipse cx="10" cy="15" rx="8" ry="3" fill="#ec4899" fill-opacity="0.6" />
                        </svg>
                        <span x-text="sharedDb ? `Shared: ${sharedDb.name}` : 'VileSQL Database Manager'"></span>
                    </h1>
                </div>

                <div x-show="message.text" class="alert"
                    :class="message.type === 'error' ? 'alert-error' : 'alert-success'" style="margin: 12px;">
                    <span x-text="message.text"></span>
                </div>

                <div class="main-layout">
                    <!-- Sidebar -->
                    <div class="sidebar">
                        <div>
                            <div class="database-list">
                                <div class="section-header">
                                    Databases
                                    <button title="Shows all databases" x-text="selectedDb===null?'':'Back'"
                                        class="cursor-pointer" @click="selectedDb=null">

                                    </button>
                                </div>
                                <div class="section-body">
                                    <template x-if="sharedDb">
                                        <div x-show="selectedDb?selectedDb.name===sharedDb.name:true"
                                            class="database-item active" @click="selectDatabase(sharedDb)">
                                            <div style="font-weight: 500;" x-text="sharedDb.name"></div>
                                            <div style="font-size: 10px; color: #888;">Shared Database</div>
                                        </div>
                                    </template>

                                    <template x-if="isAuthenticated">
                                        <div>
                                            <div x-show="databases.length === 0"
                                                class="text-[#888] text-[11px] flex items-center justify-center h-[80px]">
                                                No databases found
                                            </div>

                                            <template x-for="db in databases" :key="db.id">
                                                <div x-show="selectedDb?selectedDb.name===db.name:true"
                                                    class="database-item"
                                                    :class="selectedDb && selectedDb.id === db.id ? 'active' : ''"
                                                    @click="selectDatabase(db)">
                                                    <div
                                                        style="display: flex; align-items: center; gap: 8px; font-weight: 500;">
                                                        <!-- Pink SQL Database SVG Icon -->
                                                        <svg width="18" height="18" viewBox="0 0 20 20" fill="none"
                                                            style="flex-shrink:0;" xmlns="http://www.w3.org/2000/svg">
                                                            <ellipse cx="10" cy="5" rx="8" ry="3" fill="#ec4899" />
                                                            <ellipse cx="10" cy="10" rx="8" ry="3" fill="#ec4899"
                                                                fill-opacity="0.8" />
                                                            <ellipse cx="10" cy="15" rx="8" ry="3" fill="#ec4899"
                                                                fill-opacity="0.6" />
                                                        </svg>
                                                        <span x-text="db.name"></span>
                                                    </div>
                                                    <div style="font-size: 10px; color: #888; margin-top: 2px;">
                                                        <span
                                                            x-text="new Date(db.created_at).toLocaleDateString()"></span>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </template>
                                </div>
                            </div>

                            <!-- Tables Section -->
                            <div x-show="selectedDb && tables.length > 0" class="tables-section flex-grow">
                                <div class="section-header">Tables</div>
                                <div class="section-body">
                                    <template x-for="table in tables" :key="table">
                                        <div class="table-item" :class="selectedTable === table ? 'active' : ''"
                                            @click="selectTable(table)">
                                            <!-- Table SVG Icon -->
                                            <svg class="table-icon" width="12" height="12" viewBox="0 0 16 16"
                                                fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <rect x="1" y="2" width="14" height="12" rx="2" fill="#60a5fa" />
                                                <rect x="1" y="5" width="14" height="1" fill="#2563eb" />
                                                <rect x="1" y="8" width="14" height="1" fill="#2563eb" />
                                                <rect x="1" y="11" width="14" height="1" fill="#2563eb" />
                                            </svg>
                                            <span x-text="table"></span>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>

                        <div x-show="isAuthenticated" class="user-info">
                            <div class="flex flex-col gap-2 w-full">
                                <button class="btn btn-primary" style="width: 100%;" @click="showCreateModal = true">
                                    <!-- plus icon -->
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none"
                                        style="vertical-align: middle;" xmlns="http://www.w3.org/2000/svg">
                                        <rect x="7" y="2" width="2" height="12" rx="1" fill="#fff" />
                                        <rect x="2" y="7" width="12" height="2" rx="1" fill="#fff" />
                                    </svg>
                                    New Database
                                </button>
                                <div class="flex items-center justify-center gap-2">
                                    <span x-show="isAuthenticated" style="margin-right: 16px; font-size: 12px;">
                                        Welcome, <span x-text="user"></span>
                                    </span>
                                    <button x-show="isAuthenticated" class="btn btn-secondary" @click="logout()">
                                        <!-- logout icon -->
                                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none"
                                            style="vertical-align: middle;" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M6 2H3.5A1.5 1.5 0 0 0 2 3.5v9A1.5 1.5 0 0 0 3.5 14H6"
                                                stroke="#fff" stroke-width="1.5" stroke-linecap="round" />
                                            <path d="M10.5 11L14 8m0 0l-3.5-3M14 8H6" stroke="#fff" stroke-width="1.5"
                                                stroke-linecap="round" stroke-linejoin="round" />
                                        </svg>
                                        Logout
                                    </button>
                                    <button x-show="sharedDb && !isAuthenticated" class="btn btn-secondary"
                                        @click="sharedDb = null; sharedToken = ''">
                                        <!-- close icon -->
                                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none"
                                            style="vertical-align: middle;" xmlns="http://www.w3.org/2000/svg">
                                            <line x1="4" y1="4" x2="12" y2="12" stroke="#fff" stroke-width="2" />
                                            <line x1="12" y1="4" x2="4" y2="12" stroke="#fff" stroke-width="2" />
                                        </svg>
                                        Close
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Content Area -->
                    <div class="content-area" style="position: relative;">
                        <template x-if="loading">
                            <div class="loading-overlay">
                                <div class="spinner"></div>
                            </div>
                        </template>

                        <!-- Toolbar -->
                        <div class="toolbar">
                            <template x-if="selectedDb">
                                <div class="flex gap-2 w-full">
                                    <template x-if="!selectedTable">
                                        <button class="btn btn-primary" @click="showTableModal = true">
                                            <!-- Table SVG Icon -->
                                            <svg class="table-icon" width="12" height="12" viewBox="0 0 16 16"
                                                fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <rect x="1" y="2" width="14" height="12" rx="2" fill="#60a5fa" />
                                                <rect x="1" y="5" width="14" height="1" fill="#2563eb" />
                                                <rect x="1" y="8" width="14" height="1" fill="#2563eb" />
                                                <rect x="1" y="11" width="14" height="1" fill="#2563eb" />
                                            </svg>
                                            New Table
                                        </button>
                                    </template>
                                    <template x-if="selectedTable">
                                        <button class="btn btn-success" @click="showInsertModal = true">
                                            <!-- plus icon -->
                                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"
                                                style="vertical-align: middle;" xmlns="http://www.w3.org/2000/svg">
                                                <rect x="7" y="2" width="2" height="12" rx="1" fill="#fff" />
                                                <rect x="2" y="7" width="12" height="2" rx="1" fill="#fff" />
                                            </svg>
                                            Insert Data
                                        </button>
                                    </template>

                                    <template x-if="selectedTable">
                                        <button type="button" class="btn btn-secondary"
                                            @click="selectTable(selectedTable)">
                                            <!-- reload icon -->
                                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"
                                                style="vertical-align: middle; margin-right: 4px;"
                                                xmlns="http://www.w3.org/2000/svg">
                                                <path d="M2 8a6 6 0 1 1 2.47 4.85" stroke="#ffff" stroke-width="1.5"
                                                    fill="none" />
                                                <path d="M2 12v-3h3" stroke="#ffff" stroke-width="1.5" fill="none" />
                                            </svg>
                                            Reload Table
                                        </button>
                                    </template>

                                    <template x-if="isAuthenticated && selectedDb && !selectedTable">
                                        <button class="btn btn-secondary" @click="tab='info'; showConfigModal = true"
                                            title="Database Info & Connection">
                                            <!-- gear icon -->
                                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"
                                                style="vertical-align: middle;" xmlns="http://www.w3.org/2000/svg">
                                                <circle cx="8" cy="8" r="2" fill="#fff" />
                                                <path d="M2 8a6 6 0 0 1 12 0" stroke="#fff" stroke-width="1.2"
                                                    fill="none" />
                                                <path
                                                    d="M8 2v2M8 12v2M2 8h2M12 8h2M3.5 3.5l1.5 1.5M11 11l1.5 1.5M3.5 12.5l1.5-1.5M11 5l1.5-1.5"
                                                    stroke="#fff" stroke-width="1" fill="none" />
                                            </svg>
                                            Configurations
                                        </button>
                                    </template>

                                    <template x-if="isAuthenticated && selectedTable">
                                        <button class="btn btn-danger" style="margin-left: auto;"
                                            @click="showDeleteTableModal=true">
                                            <!-- trash icon -->
                                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"
                                                style="vertical-align: middle;" xmlns="http://www.w3.org/2000/svg">
                                                <rect x="3" y="6" width="10" height="7" rx="2" fill="#fff"
                                                    fill-opacity="0.15" />
                                                <rect x="3" y="6" width="10" height="7" rx="2" stroke="#fff"
                                                    stroke-width="1" />
                                                <rect x="7" y="9" width="2" height="3" rx="1" fill="#fff" />
                                                <rect x="5" y="3" width="6" height="2" rx="1" fill="#fff" />
                                                <rect x="6" y="2" width="4" height="1" rx="0.5" fill="#fff"
                                                    fill-opacity="0.5" />
                                                <rect x="2" y="5" width="12" height="1" fill="#fff" />
                                                <line x1="6" y1="8" x2="10" y2="12" stroke="#d83b01"
                                                    stroke-width="1.5" />
                                                <line x1="10" y1="8" x2="6" y2="12" stroke="#d83b01"
                                                    stroke-width="1.5" />
                                            </svg>
                                            Delete Table
                                        </button>
                                    </template>

                                    <template x-if="isAuthenticated && selectedDb && !selectedTable">
                                        <button class="btn btn-danger" style="margin-left: auto;"
                                            @click="showDeleteModal = true">
                                            <!-- trash icon -->
                                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"
                                                style="vertical-align: middle;" xmlns="http://www.w3.org/2000/svg">
                                                <rect x="3" y="6" width="10" height="7" rx="2" fill="#fff"
                                                    fill-opacity="0.15" />
                                                <rect x="3" y="6" width="10" height="7" rx="2" stroke="#fff"
                                                    stroke-width="1" />
                                                <rect x="7" y="9" width="2" height="3" rx="1" fill="#fff" />
                                                <rect x="5" y="3" width="6" height="2" rx="1" fill="#fff" />
                                                <rect x="6" y="2" width="4" height="1" rx="0.5" fill="#fff"
                                                    fill-opacity="0.5" />
                                                <rect x="2" y="5" width="12" height="1" fill="#fff" />
                                                <line x1="6" y1="8" x2="10" y2="12" stroke="#d83b01"
                                                    stroke-width="1.5" />
                                                <line x1="10" y1="8" x2="6" y2="12" stroke="#d83b01"
                                                    stroke-width="1.5" />
                                            </svg>
                                            Delete DB
                                        </button>
                                    </template>
                                </div>
                            </template>
                        </div>

                        <!-- Filter Bar -->
                        <div x-show="selectedTable && tableData.length > 0" class="filter-bar">
                            <label>Filter:</label>
                            <input type="text" class="filter-input" x-model="filterText"
                                placeholder="Search in table...">
                            <span style="margin-left: auto; color: #888;"
                                x-text="`${filteredTableData.length} rows`"></span>
                        </div>


                        <!-- Data Table -->
                        <div class="data-table-container">
                            <template x-if="!selectedDb">
                                <div class="empty-state">
                                    <!-- database icon -->
                                    <svg width="48" height="48" viewBox="0 0 20 20" fill="none" style="flex-shrink:0;"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <ellipse cx="10" cy="5" rx="8" ry="3" fill="#ec4899" />
                                        <ellipse cx="10" cy="10" rx="8" ry="3" fill="#ec4899" fill-opacity="0.8" />
                                        <ellipse cx="10" cy="15" rx="8" ry="3" fill="#ec4899" fill-opacity="0.6" />
                                    </svg>
                                    <h3>Select a database to get started</h3>
                                    <p>Choose a database from the sidebar to explore its contents</p>
                                </div>
                            </template>

                            <template x-if="selectedDb && !selectedTable">
                                <div class="empty-state">
                                    <!-- table icon -->
                                    <svg width="48" height="48" viewBox="0 0 16 16" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <rect x="1" y="2" width="14" height="12" rx="2" fill="#60a5fa" />
                                        <rect x="1" y="5" width="14" height="1" fill="#2563eb" />
                                        <rect x="1" y="8" width="14" height="1" fill="#2563eb" />
                                        <rect x="1" y="11" width="14" height="1" fill="#2563eb" />
                                    </svg>
                                    <h3>Select a table to view data</h3>
                                    <p>Choose a table from the sidebar or create a new one</p>
                                </div>
                            </template>

                            <template x-if="selectedTable && tableColumns.length > 0">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th class="cursor-pointer row-number"
                                                @click="tab ='editType'; showColumnInfo=true"
                                                title="Click to open column modal">#</th>
                                            <template x-for="(column, colIndex) in tableColumns" :key="column.name">
                                                <th style="min-width: 300px;" title="Click to edit column name"
                                                    @click="editingCell = { row: -1, col: column.name, value: column.name }">
                                                    <div class="flex justify-between items-center">
                                                        <template
                                                            x-if="editingCell && editingCell.row === -1 && editingCell.col === column.name">
                                                            <input type="text" class="form-control text-[11px]"
                                                                x-model="editingCell.value" @keydown.enter.stop.prevent="
                                                                    updateColumnName(editingCell);
                                                                    editingCell = null;
                                                                " @keydown.esc="editingCell = null"
                                                                @blur="editingCell = null"
                                                                style="padding:2px 6px; min-width: 60px;" autofocus>
                                                        </template>
                                                        <template
                                                            x-if="!editingCell || editingCell.row !== -1 || editingCell.col !== column.name">
                                                            <span x-text="column.name" class="cursor-pointer"></span>
                                                        </template>
                                                        <template x-if="column.constraint">
                                                            <div
                                                                class="text-[10px] text-[#60a5fa] mr-2 ml-auto flex gap-[2px] cursor-pointer">
                                                                <span x-text="column.constraint.type"></span>
                                                                <span
                                                                    x-text="column.constraint.unique ? 'UNIQUE' : ''"></span>
                                                                <span
                                                                    x-text="column.constraint.primary_key ? 'PRIMARY' : ''"></span>
                                                                <span
                                                                    x-text="column.constraint.not_null ? 'NOT NULL' : ''"></span>
                                                            </div>
                                                        </template>
                                                    </div>
                                                </th>
                                            </template>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Data rows -->
                                        <template x-for="(row, index) in filteredTableData" :key="index">
                                            <tr>
                                                <td class="row-number cursor-pointer"
                                                    x-text="selectShowDeleteRowIcon===index ? 'üóëÔ∏è' : index + 1"
                                                    @mouseover="selectShowDeleteRowIcon = index"
                                                    @mouseenter="selectShowDeleteRowIcon = index"
                                                    @mouseleave="selectShowDeleteRowIcon = null"
                                                    @click="showRowDropdown = { row: row, index: index }">
                                                </td>

                                                <template x-for="(column, colIndex) in tableColumns" :key="column.name">
                                                    <td style="min-width: 300px;" @dblclick="
                                                            if (!editingCell || editingCell.row !== index || editingCell.col !== column.name) {
                                                                editingCell = { row: index, col: column.name, value: Array.isArray(row) ? row[colIndex] : row[column.name] }
                                                            }
                                                        ">
                                                        <template
                                                            x-if="editingCell && editingCell.row === index && editingCell.col === column.name">
                                                            <input type="text" class="form-control text-[11px]"
                                                                x-model="editingCell.value" @keydown.enter.stop.prevent="
                                                                    updateCell(index, column.name, editingCell.value, row[colIndex]);
                                                                    editingCell = null;
                                                                " @keydown.esc="editingCell = null"
                                                                @blur="editingCell = null"
                                                                style="padding:2px 6px; min-width: 60px;" autofocus>
                                                        </template>
                                                        <template
                                                            x-if="!editingCell || editingCell.row !== index || editingCell.col !== column.name">
                                                            <span
                                                                x-text="Array.isArray(row) ? (row[colIndex] !== null ? row[colIndex] : 'NULL') : (row[column.name] !== null ? row[column.name] : 'NULL')"
                                                                :title="Array.isArray(row) ? row[colIndex] : row[column.name]"></span>
                                                        </template>
                                                    </td>
                                                </template>
                                            </tr>
                                        </template>
                                        <!-- Extra row for adding data -->
                                        <tr>
                                            <td class="row-number">+</td>
                                            <template x-for="(column, colIndex) in tableColumns" :key="column.name">
                                                <td style="min-width: 300px;">
                                                    <input type="text" class="form-control text-[11px]"
                                                        :placeholder="column.name" x-model="insertRow[column.name]"
                                                        @keydown.enter.stop.prevent="addRow()" style="padding:2px 6px;">
                                                </td>
                                            </template>
                                        </tr>
                                    </tbody>
                                </table>
                            </template>
                        </div>

                        <!-- Query Panel -->
                        <div x-show="selectedDb" class="query-panel">
                            <div class="form-group">
                                <label>SQL Query</label>
                                <textarea class="query-editor" x-model="queryText" :placeholder="selectedTable && tableColumns.length > 0
                                        ? `INSERT INTO ${selectedTable} (${tableColumns.map(col => col.name).join(', ')}) VALUES (${tableColumns.map(col => `'${col.name}'`).join(', ')})`
                                        : 'Enter your SQL query here...'
                                    "></textarea>
                            </div>
                            <div class="flex gap-2">
                                <button class="btn btn-primary" @click="executeQuery()"
                                    :disabled="!queryText.trim() || loading">
                                    <i data-lucide="play"></i>
                                    Execute
                                </button>
                                <button class="btn btn-secondary" @click="queryText = ''">
                                    Clear
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>


    <template x-if="isAuthenticated || sharedDb">
        <div>
            <!-- column info -->
            <template x-if="showColumnInfo && selectedDb && tab != null && selectedTable && tableColumns.length > 0">
                <div class="modal" @click.self="showColumnInfo = false">
                    <div class="modal-content" style="min-width: 420px;">
                        <h3 style="margin-bottom: 16px;">Edit Columns for <span class="text-[#2563eb]"
                                x-text="selectedTable"></span></h3>
                        <div class="tab-nav" style="margin-bottom: 12px;">
                            <button class="tab-btn" :class="tab==='editType' ? 'active' : ''"
                                @click="tab='editType'">Add Column</button>
                            <button class="tab-btn" :class="tab==='danger' ? 'active' : ''"
                                @click="tab='danger'">Danger</button>
                        </div>
                        <!-- Edit Type Tab -->
                        <div x-show="tab==='editType'">
                            <h4 style="margin-bottom: 8px;">Add New Column</h4>
                            <form
                                @submit.prevent="addColumn(newColumnName, newColumnType); newColumnName=''; newColumnType=''; showColumnInfo=false;">
                                <div class="form-group flex items-center gap-2">
                                    <input type="text" class="form-control w-1/2" placeholder="Column Name"
                                        x-model="newColumnName" required />
                                    <input type="text" class="form-control w-1/2"
                                        placeholder="Column Type (e.g. TEXT, INTEGER)" x-model="newColumnType"
                                        required />
                                    <button type="submit" class="btn btn-primary btn-sm"
                                        :disabled="!newColumnName || !newColumnType">Add</button>
                                </div>
                            </form>
                        </div>
                        <!-- Danger Tab -->
                        <div x-show="tab==='danger'">
                            <template x-for="(column, colIndex) in tableColumns" :key="column.name">
                                <div class="form-group flex items-center gap-2">
                                    <label class="w-1/2" x-text="column.name"></label>
                                    <button class="btn btn-danger btn-sm"
                                        @click="deleteColumn({col: column.name}); showColumnInfo=false"
                                        :disabled="tableColumns.length <= 1">
                                        Delete Column
                                    </button>
                                </div>
                            </template>
                            <div class="alert alert-warning mt-2">
                                <strong>Warning:</strong> Deleting a column is irreversible and may result in data loss.
                            </div>
                        </div>
                        <div class="flex gap-2" style="margin-top: 16px;">
                            <button type="button" class="btn btn-secondary"
                                @click="showColumnInfo = false">Close</button>
                        </div>
                    </div>
                </div>
            </template>

            <!-- configuration modal -->
            <template x-if="showConfigModal && selectedDb && tab != null">
                <div class="modal" @click.self="showConfigModal = false">
                    <div class="modal-content" style="min-width: 420px;">
                        <h3 style="margin-bottom: 16px;">Database Configuration</h3>
                        <div>
                            <div class="tab-nav" style="margin-bottom: 12px;">
                                <button class="tab-btn" :class="tab==='info' ? 'active' : ''"
                                    @click="tab='info'">Info</button>
                                <button class="tab-btn" :class="tab==='share' ? 'active' : ''"
                                    @click="tab='share'">Share</button>
                                <button class="tab-btn" x-show="selectedDb.share_token"
                                    :class="tab==='connect' ? 'active' : ''" @click="tab='connect'">Connect</button>
                                <button class="tab-btn" :class="tab==='backup' ? 'active' : ''"
                                    @click="tab='backup'">Backup</button>
                            </div>
                            <!-- Info Tab -->
                            <div x-show="tab==='info'">
                                <div class="form-group">
                                    <label>Database ID</label>
                                    <input type="text" class="form-control" :value="selectedDb.id" readonly>
                                </div>
                                <div class="form-group">
                                    <label>Database Name</label>
                                    <input type="text" class="form-control" :value="selectedDb.name" readonly>
                                </div>
                                <div class="form-group">
                                    <label>Database Owner</label>
                                    <input type="text" class="form-control" :value="selectedDb.username || 'N/A'"
                                        readonly>
                                </div>
                                <div class="form-group">
                                    <label>Created At</label>
                                    <input type="text" class="form-control"
                                        :value="new Date(selectedDb.created_at).toLocaleString()" readonly>
                                </div>
                            </div>
                            <!-- Share Tab -->
                            <div x-show="tab==='share'">
                                <template x-if="selectedDb.share_token">
                                    <div>
                                        <div class="alert alert-success" style="margin-bottom: 8px;">
                                            <span>This database is currently <strong>shared</strong>.</span>
                                        </div>
                                        <div class="form-group">
                                            <label>Share Token</label>
                                            <div @click="navigator.clipboard.writeText(selectedDb.share_token)"
                                                class="flex items-center gap-2 form-control">
                                                <input type="text" class="flex-grow" :value="selectedDb.share_token"
                                                    readonly>
                                                <button type="button" class="cursor-pointer" title="Copy token" @click="navigator.clipboard.writeText(selectedDb.share_token); 
                                                        showTick='copied_token'
                                                        setTimeout(() => { showTick = null; }, 2000);">
                                                    <!-- Tick SVG icon -->
                                                    <div x-show="showTick==='copied_token'">
                                                        ‚úÖ 
                                                    </div>

                                                    <!-- Copy SVG icon -->
                                                    <svg x-show="showTick===null" width="20" height="20"
                                                        viewBox="0 0 24 24" fill="none"
                                                        xmlns="http://www.w3.org/2000/svg">
                                                        <rect x="4" y="6" width="16" height="12" rx="3" fill="#d1d5db"
                                                            fill-opacity="0.5" />
                                                        <rect x="4" y="6" width="16" height="12" rx="3" stroke="#6b7280"
                                                            stroke-width="1.5" />
                                                        <rect x="8" y="2" width="8" height="16" rx="2" fill="#6b7280"
                                                            fill-opacity="0.2" />
                                                        <rect x="8" y="2" width="8" height="16" rx="2" stroke="#6b7280"
                                                            stroke-width="1.5" />
                                                    </svg>
                                                </button>
                                            </div>
                                            <p class="flex flex-col" style="margin-top: 4px;">
                                                <small class="text-[#888] text-[11px]">Use this token to access the
                                                    database via API.</small>
                                                <small class="text-[11px]">
                                                    <span class="text-[#888]">Expires on:</span> <span
                                                        x-text="new Date(selectedDb.token_expiry).toLocaleString()"></span>
                                                </small>
                                            </p>
                                        </div>
                                        <div class="form-group">
                                            <label>Share Link</label>
                                            <div @click="navigator.clipboard.writeText(window.location.origin + '/api/shared/' + selectedDb.share_token)"
                                                class="flex items-center gap-2 form-control">
                                                <input type="text" class="flex-grow"
                                                    :value="window.location.origin + '/api/shared/' + selectedDb.share_token"
                                                    readonly>
                                                <button type="button" class="cursor-pointer" title="Copy link" @click="navigator.clipboard.writeText(window.location.origin + '/api/shared/' + selectedDb.share_token)
                                                        showTick='copied_share_link'
                                                        setTimeout(() => { showTick = null; }, 2000);
                                                    ">
                                                    <!-- Tick SVG icon -->
                                                    <div x-show="showTick==='copied_share_link'">
                                                        ‚úÖ 
                                                    </div>

                                                    <!-- Copy SVG icon -->
                                                    <svg x-show="showTick===null" width="20" height="20"
                                                        viewBox="0 0 24 24" fill="none"
                                                        xmlns="http://www.w3.org/2000/svg">
                                                        <rect x="4" y="6" width="16" height="12" rx="3" fill="#d1d5db"
                                                            fill-opacity="0.5" />
                                                        <rect x="4" y="6" width="16" height="12" rx="3" stroke="#6b7280"
                                                            stroke-width="1.5" />
                                                        <rect x="8" y="2" width="8" height="16" rx="2" fill="#6b7280"
                                                            fill-opacity="0.2" />
                                                        <rect x="8" y="2" width="8" height="16" rx="2" stroke="#6b7280"
                                                            stroke-width="1.5" />
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                        <button class="btn btn-primary w-full" style="margin-top: 8px;"
                                            @click="renewShareToken(selectedDb); showConfigModal = false;">
                                            <!-- edit icon -->
                                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"
                                                style="vertical-align: middle; margin-right: 4px;"
                                                xmlns="http://www.w3.org/2000/svg">
                                                <path
                                                    d="M12.8 3.2a1.067 1.067 0 0 1 1.507 1.507l-7.2 7.2-2.4.267.267-2.4 7.2-7.2z"
                                                    stroke="#fff" stroke-width="1.2" fill="none" />
                                                <rect x="2" y="11" width="3" height="1.2" rx="0.6" fill="#fff" />
                                            </svg>
                                            Update Token
                                        </button>
                                        <button
                                            x-show="selectedDb.token_expiry && new Date(selectedDb.token_expiry) < new Date()"
                                            class="btn btn-secondary w-full" style="margin-top: 8px;"
                                            @click="renewTokenExpiry(selectedDb); showConfigModal = false;">
                                            <!-- reload icon -->
                                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"
                                                style="vertical-align: middle; margin-right: 4px;"
                                                xmlns="http://www.w3.org/2000/svg">
                                                <path d="M2 8a6 6 0 1 1 2.47 4.85" stroke="#ffff" stroke-width="1.5"
                                                    fill="none" />
                                                <path d="M2 12v-3h3" stroke="#ffff" stroke-width="1.5" fill="none" />
                                            </svg>
                                            Extend Token Expiry Period
                                        </button>
                                        <button class="btn btn-danger w-full" style="margin-top: 8px;"
                                            @click="shareDatabase(selectedDb); showConfigModal = false;">
                                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"
                                                style="vertical-align: middle;" xmlns="http://www.w3.org/2000/svg">
                                                <rect x="3" y="7" width="10" height="7" rx="2" fill="#fff"
                                                    fill-opacity="0.15" />
                                                <rect x="3" y="7" width="10" height="7" rx="2" stroke="#fff"
                                                    stroke-width="1" />
                                                <rect x="7" y="10" width="2" height="3" rx="1" fill="#fff" />
                                                <path d="M5 7V5a3 3 0 1 1 6 0v2" stroke="#fff" stroke-width="1"
                                                    fill="none" />
                                            </svg>
                                            Unshare Database
                                        </button>
                                    </div>
                                </template>
                                <template x-if="!selectedDb.share_token">
                                    <div>
                                        <div class="alert alert-info" style="margin-bottom: 8px;">
                                            <span>This database is <strong>private</strong>.</span>
                                        </div>
                                        <button class="btn btn-primary w-full"
                                            @click="shareDatabase(selectedDb); showConfigModal = false;">
                                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"
                                                style="vertical-align: middle;" xmlns="http://www.w3.org/2000/svg">
                                                <rect x="3" y="7" width="10" height="7" rx="2" fill="#fff"
                                                    fill-opacity="0.15" />
                                                <rect x="3" y="7" width="10" height="7" rx="2" stroke="#fff"
                                                    stroke-width="1" />
                                                <rect x="7" y="10" width="2" height="3" rx="1" fill="#fff" />
                                                <path d="M8 7V5a3 3 0 0 1 6 0" stroke="#fff" stroke-width="1"
                                                    fill="none" />
                                                <circle cx="12" cy="5" r="1" fill="#fff" />
                                            </svg>
                                            Share Database
                                        </button>
                                    </div>
                                </template>
                            </div>
                            <!-- Connect Tab -->
                            <div x-show="selectedDb.share_token &&tab==='connect'">
                                <div class="form-group">
                                    <label>Connection Link</label>
                                    <div @click="
                                            navigator.clipboard.writeText(window.location.origin + '/api/shared/' + selectedDb.share_token + '/query');
                                            showTick='copied_connection_link';
                                            setTimeout(() => { showTick = null; }, 2000);
                                        "
                                        class="flex items-center gap-2 form-control"
                                        >
                                        <input type="text" class="flex-grow"
                                            :value="window.location.origin + '/api/shared/' + selectedDb.share_token + '/query'"
                                            readonly>
                                        <button type="button" class="cursor-pointer" title="Copy link"
                                            @click="navigator.clipboard.writeText(window.location.origin + '/api/shared/' + selectedDb.share_token + '/query');
                                            showTick='copied_connection_link';
                                            setTimeout(() => { showTick = null; }, 2000);
                                        ">
                                            <!-- Tick SVG icon -->
                                            <div x-show="showTick==='copied_connection_link'">
                                                ‚úÖ 
                                            </div>

                                            <!-- Copy SVG icon -->
                                            <svg x-show="showTick===null" width="20" height="20" viewBox="0 0 24 24"
                                                fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <rect x="4" y="6" width="16" height="12" rx="3" fill="#d1d5db"
                                                    fill-opacity="0.5" />
                                                <rect x="4" y="6" width="16" height="12" rx="3" stroke="#6b7280"
                                                    stroke-width="1.5" />
                                                <rect x="8" y="2" width="8" height="16" rx="2" fill="#6b7280"
                                                    fill-opacity="0.2" />
                                                <rect x="8" y="2" width="8" height="16" rx="2" stroke="#6b7280"
                                                    stroke-width="1.5" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Instructions</label>
                                    <div style="font-size: 12px; color: #888;">
                                        <ol style="padding-left: 18px;">
                                            <li>1. Use the Connection link above to access this database
                                                programmatically.</li>
                                            <li>2. For shared databases, use the share token in the URL or via
                                                <code
                                                    x-text="window.location.origin + '/api/shared/&lt;token&gt;'"></code>.
                                            </li>
                                            <li>3. Example: <br />
                                                <div class="form-control"
                                                    @click="navigator.clipboard.writeText(`curl -X POST -H 'Content-Type: application/json' -d '{\'sql\':\'SELECT * FROM mytable\'}' ${window.location.origin}/api/shared/${selectedDb.share_token}/query`)">
                                                    <code
                                                        x-text="`curl -X POST -H 'Content-Type: application/json' -d '{\'sql\':\'SELECT * FROM mytable\'}' ${window.location.origin}/api/shared/${selectedDb.share_token}/query`"></code>
                                                </div>
                                            </li>
                                            <li>4. For more details, see the documentation or contact your
                                                administrator.</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                            <!-- backup -->
                            <div x-show="tab==='backup'">
                                <div class="form-group">
                                    <label>Filename</label>
                                    <input type="text" :placeholder="selectedDb.name" :placeholder="selectedDB.name" class="form-control" x-model="backup_filename">
                                </div>
                                <div class="form-group">
                                    <label>Format</label>
                                    <div class="w-full">
                                        <select class="format-selector" x-model="backup_format" style="width: 100%;"
                                            id="">
                                            <option value="custom" disabled>Select format</option>
                                            <option value="sqlite">Custom (.sqlite)</option>
                                            <option value="tar">Tar (.tar)</option>
                                            <option value="zip">Directory (.zip)</option>
                                        </select>
                                    </div>
                                </div>
                                <button class="btn btn-success w-full" style="margin-top: 8px;"
                                    @click="backupDB(selectedDb); showConfigModal = false;">
                                    <!-- disk icon -->
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none"
                                        style="vertical-align: middle; margin-right: 4px;"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <rect x="2" y="2" width="12" height="12" rx="2" fill="#2563eb" />
                                        <rect x="4" y="4" width="8" height="6" rx="1" fill="#fff" />
                                        <rect x="6" y="11" width="4" height="2" rx="1" fill="#fff" />
                                    </svg>
                                    Backup Database
                            </div>
                        </div>
                        <div class="flex gap-2" style="margin-top: 16px;">
                            <button type="button" class="btn btn-secondary"
                                @click="showConfigModal = false">Close</button>
                        </div>
                    </div>
                </div>
            </template>

            <!-- delete row modal -->
            <div x-show="showRowDropdown!=null" @click.self="showRowDropdown = null" class="modal">
                <div class="modal-content">
                    <h3 style="margin-bottom: 16px;">You've selected row #<span
                            x-text="showRowDropdown ? showRowDropdown.index + 1 : ''"></span></h3>
                    <button @click="deleteRow(showRowDropdown.row, showRowDropdown.index)"
                        style="padding: 6px 16px; color: white; margin-bottom:8px;"
                        class="btn btn-danger w-full text-left rounded-md cursor-pointer">
                        üóëÔ∏è Delete Row
                    </button>
                    <button type="button" class="btn btn-secondary" @click="showRowDropdown = null">Cancel</button>
                </div>
            </div>

            <!-- Delete Database Modal -->
            <div x-show="showDeleteModal" class="modal" @click.self="showDeleteModal = false">
                <div class="modal-content">
                    <h3 style="margin-bottom: 16px;">Are you sure you want to delete the
                        database
                        <strong class="text-[#2563eb]" x-text="selectedDb ? selectedDb.name : ''"></strong>? This action
                        cannot be undone.
                    </h3>
                    <form @submit.prevent="deleteDatabase(selectedDb.id)">
                        <div class="form-group">
                            <label class="text-sm mt-4">Type the database name to
                                confirm</label>
                            <input type="text" class="form-control" x-model="deleteDbName" required
                                placeholder="Enter database name to confirm">
                        </div>
                        <div class="flex gap-2">
                            <button type="submit" class="btn btn-danger"
                                :disabled="deleteDbName !== (selectedDb ? selectedDb.name : '') || loading">
                                <span x-text="loading ? 'Deleting...' : 'Delete'"></span>
                            </button>
                            <button type="button" class="btn btn-secondary"
                                @click="showDeleteModal = false">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Create Database Modal -->
            <div x-show="showCreateModal" class="modal" @click.self="showCreateModal = false">
                <div class="modal-content">
                    <h3 style="margin-bottom: 16px;">Create New Database</h3>
                    <form @submit.prevent="createDatabase()">
                        <div class="form-group">
                            <label>Database Name</label>
                            <input type="text" class="form-control" x-model="newDbName" required
                                placeholder="Enter database name">
                        </div>
                        <div class="flex gap-2">
                            <button type="submit" class="btn btn-primary" :disabled="!newDbName.trim() || loading">
                                <span x-text="loading ? 'Creating...' : 'Create'"></span>
                            </button>
                            <button type="button" class="btn btn-secondary"
                                @click="showCreateModal = false">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Create Table Modal -->
            <div x-show="showTableModal && selectedDb" class="modal" @click.self="showTableModal = false">
                <div class="modal-content">
                    <h3 style="margin-bottom: 16px;">Create New Table</h3>
                    <form @submit.prevent="createTable(); showTableModal = false; resetTableForm();">
                        <div class="form-group">
                            <label>Table Name</label>
                            <input type="text" class="form-control" x-model="newTableForm.name" required
                                placeholder="Enter table name">
                        </div>
                        <div class="form-group">
                            <label>Columns (SQL format)</label>
                            <textarea class="form-control" x-model="newTableForm.columns" required
                                placeholder="id INTEGER PRIMARY KEY, name TEXT NOT NULL, email TEXT UNIQUE"
                                rows="4"></textarea>
                            <small style="color: #888; font-size: 11px;">Example: id INTEGER PRIMARY KEY, name TEXT NOT
                                NULL,
                                email TEXT</small>
                        </div>
                        <div class="flex gap-2">
                            <button type="submit" class="btn btn-primary"
                                :disabled="!newTableForm.name.trim() || !newTableForm.columns.trim() || loading">
                                <span x-text="loading ? 'Creating...' : 'Create Table'"></span>
                            </button>
                            <button type="button" class="btn btn-secondary"
                                @click="showTableModal = false; resetTableForm()">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Insert Data Modal -->
            <div x-show="showInsertModal && selectedTable && selectedDb" class="modal"
                @click.self="showInsertModal = false">
                <div class="modal-content">
                    <h3 style="margin-bottom: 16px;">Insert Data</h3>
                    <form @submit.prevent="insertData()">
                        <div class="form-group">
                            <label>Table Name</label>
                            <template x-if="!selectedTable">
                                <input type="text" class="form-control" x-model="insertForm.table"
                                    placeholder="Enter table name" required />
                            </template>
                            <template x-if="selectedTable">
                                <input type="text" class="form-control" :value="selectedTable"
                                    :placeholder="selectedTable" readonly />
                            </template>
                        </div>
                        <div class="form-group">
                            <label>Columns (comma-separated)</label>
                            <template x-if="!selectedTable">
                                <input type="text" required class="form-control" x-model="insertForm.columns"
                                    placeholder="'name', 'email', age" />
                            </template>
                            <template x-if="selectedTable">
                                <input type="text" class="form-control"
                                    :value="tableColumns.length > 0 ? tableColumns.map(col => col.name).join(', ') : ''"
                                    :placeholder="tableColumns.length > 0 ? tableColumns.map(col => col.name).join(', ') : 'name, email, age'"
                                    readonly />
                            </template>
                        </div>
                        <div class="form-group">
                            <label>Values (comma-separated)</label>
                            <input type="text" class="form-control" x-model="insertForm.values" required
                                :placeholder="`'John Doe', 'john@example.com', 30`">
                        </div>
                        <div class="flex gap-2">
                            <button type="submit" class="btn btn-success"
                                :disabled="!insertForm.values.trim() || loading">
                                <span x-text="loading ? 'Inserting...' : 'Insert Data'"></span>
                            </button>
                            <button type="button" class="btn btn-secondary"
                                @click="showInsertModal = false; resetInsertForm()">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Delete Table Modal -->
            <div x-show="showDeleteTableModal" class="modal" @click.self="showDeleteTableModal = false">
                <div class="modal-content">
                    <h3 style="margin-bottom: 16px;">Are you sure you want to delete table
                        <strong class="text-[#2563eb]" x-text="selectedTable? selectedTable : ''"></strong>?
                    </h3>

                    <div class="flex gap-2">
                        <button @click="deleteTable" class="btn btn-danger" :disabled="loading">
                            <span x-text="loading ? 'Deleting...' : 'Delete'"></span>
                        </button>
                        <button type="button" class="btn btn-secondary"
                            @click="showDeleteTableModal = false">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <script>
        function sqlitePanel() {
            return {
                // Authentication state
                isAuthenticated: false,
                authMode: 'login',
                user: null,
                authFormRegister: { username: '', password: '', email: '' },
                authFormLogin: { username: '', password: '' },

                // UI state
                loading: false,
                screenLoading: false,
                message: { text: '', type: '' },
                tab: null,
                newColumnName: null, newColumnType: null,
                showTick: null,

                // Database state
                databases: [],
                selectedDb: null,
                tables: [],
                selectedTable: null,
                tableData: [],
                tableColumns: [],
                filterText: '',
                editingCell: null,
                selectedRow: null,
                index: 0,

                // Modals
                showCreateModal: false,
                showTableModal: false,
                showInsertModal: false,
                showDeleteModal: false,
                showDeleteTableModal: false,
                deleteDbName: '',
                sharedDbName: '',
                showRowDropdown: null,
                showDeleteRowModal: { show: false, row: null, index: null },
                showEditRowModal: false,
                selectShowDeleteRowIcon: null,
                showConfigModal: false,
                showColumnInfo: false,

                // Forms
                newDbName: '',
                newTableForm: { name: '', columns: '' },
                insertForm: { table: '', columns: '', values: '' },
                backup_filename: '',
                backup_format: '',

                // Query state
                queryText: '',
                queryResults: null,

                insertRow: {},

                // Shared database state
                sharedToken: '',
                sharedDb: null,

                init() {
                    this.checkAuth();
                },

                // Utility methods
                setMessage(text, type = 'success') {
                    this.message = { text, type };
                    setTimeout(() => {
                        this.message = { text: '', type: '' };
                    }, 5000);
                },

                async apiCall(url, options = {}) {
                    try {
                        const response = await fetch(url, {
                            credentials: 'include',
                            headers: {
                                'Content-Type': 'application/json',
                                ...options.headers
                            },
                            ...options
                        });

                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(errorText || `HTTP ${response.status}`);
                        }

                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            return await response.json();
                        }
                        return null;
                    } catch (error) {
                        throw error;
                    }
                },

                // Authentication methods
                async checkAuth() {
                    this.screenLoading = true
                    try {
                        const result = await this.apiCall('/api/authenticate');
                        this.user = result?.data.user.username || null;
                        this.isAuthenticated = result?.data.authenticated || false;
                        // console.log(result.data)
                        if (this.isAuthenticated) {
                            this.loadDatabases();
                        }
                    } catch (error) {
                        this.isAuthenticated = false;
                        this.user = null;
                    }
                    this.screenLoading = false
                },

                async register() {
                    if (!this.authFormRegister.username.trim() || !this.authFormRegister.password.trim() || !this.authFormRegister.email.trim()) return;

                    this.loading = true;
                    try {
                        await this.apiCall('/api/register', {
                            method: 'POST',
                            body: JSON.stringify(this.authFormRegister)
                        });
                        this.setMessage('Registration successful! Please login.', 'success');
                        this.authMode = 'login';
                        this.authFormRegister = { username: '', password: '', email: '' };
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                    this.loading = false;
                },

                async login() {
                    if (!this.authFormLogin.username.trim() || !this.authFormLogin.password.trim()) return;

                    this.loading = true;
                    try {
                        const result = await this.apiCall('/api/login', {
                            method: 'POST',
                            body: JSON.stringify(this.authFormLogin)
                        });

                        this.isAuthenticated = true;
                        this.user = result?.user || this.authFormLogin.username;
                        this.setMessage('Login successful!', 'success');
                        this.loadDatabases();
                        this.authFormLogin = { username: '', password: '' };
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                    this.loading = false;
                },

                async logout() {
                    try {
                        await this.apiCall('/api/logout', { method: 'POST' });
                        this.isAuthenticated = false;
                        this.user = null;
                        this.databases = [];
                        this.selectedDb = null;
                        this.queryResults = null;
                        this.setMessage('Logged out successfully', 'success');
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                },

                // Database management methods
                async loadDatabases() {
                    try {
                        const result = await this.apiCall('/api/databases');
                        this.databases = result.data || [];
                    } catch (error) {
                        this.setMessage('Failed to load databases', 'error');
                    }
                },

                async createDatabase() {
                    if (!this.newDbName.trim()) return;

                    this.loading = true;
                    try {
                        const result = await this.apiCall('/api/databases', {
                            method: 'POST',
                            body: JSON.stringify({ name: this.newDbName })
                        });

                        this.newDbName = '';
                        this.showCreateModal = false;
                        this.loadDatabases();
                        if (this.selectedDb) {
                            this.selectedDb = result.data || [];
                        }
                        this.setMessage('Database created successfully!', 'success');
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                    this.loading = false;
                },

                async deleteDatabase(id) {
                    try {
                        if (!id || !this.selectedDb) return;
                        if (this.deleteDbName !== this.selectedDb.name) {
                            this.setMessage('Please enter the correct database name to confirm deletion.', 'error');
                            return;
                        }
                        this.loading = true;

                        await this.apiCall(`/api/databases/${id}`, { method: 'DELETE' });
                        this.loadDatabases();
                        if (this.selectedDb && this.selectedDb.id === id) {
                            this.selectedDb = null;
                            this.queryResults = null;
                            this.showDeleteModal = false;
                            this.deleteDbName = '';
                        }
                        this.setMessage('Database deleted successfully', 'success');
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                    this.loading = false;
                },

                async shareDatabase(database) {
                    try {
                        if (database.share_token) {
                            // Disable sharing
                            await this.apiCall(`/api/databases/${database.id}/share`, { method: 'DELETE' });
                            this.selectedDb.share_token = '';
                            this.selectedDb.token_expiry = '';
                            this.setMessage('Database sharing disabled', 'success');
                        } else {
                            // Enable sharing
                            const result = await this.apiCall(`/api/databases/${database.id}/share`, { method: 'POST' });
                            this.selectedDb.share_token = result.data.share_token;
                            this.selectedDb.token_expiry = result.data.token_expiry;
                            this.setMessage(`Database shared! Token: ${result.data.share_token}`, 'success');
                        }
                        this.loadDatabases();
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                },

                async renewTokenExpiry(database) {
                    try {
                        if (!database || !database.id) return;
                        this.loading = true;

                        const result = await this.apiCall(`/api/databases/${database.id}/share/renew`, { method: 'PATCH' });
                        this.selectedDb.share_token = result.data.share_token;
                        this.selectedDb.token_expiry = result.data.token_expiry;
                        this.setMessage('Share token expiry period renewed successfully!', 'success');
                        this.loadDatabases();
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                    this.loading = false;
                },

                async renewShareToken(database) {
                    try {
                        if (!database || !database.id) return;
                        this.loading = true;

                        const result = await this.apiCall(`/api/databases/${database.id}/share/renew`, { method: 'POST' });
                        this.selectedDb.share_token = result.data.share_token;
                        this.selectedDb.token_expiry = result.data.token_expiry;
                        this.setMessage('Share token updated successfully!', 'success');
                        this.loadDatabases();
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                    this.loading = false;
                },

                async selectDatabase(database) {
                    this.selectedDb = database;
                    this.selectedTable = null;
                    this.tables = [];
                    this.tableData = [];
                    this.tableColumns = [];
                    this.queryResults = null;
                    this.queryText = '';
                    this.loading = true;
                    try {
                        // Load tables for the selected database
                        const result = await this.apiCall(`/api/databases/${database.id}/tables`);
                        this.tables = result.data || [];
                    } catch (error) {
                        this.setMessage('Failed to load tables', 'error');
                    }
                    this.loading = false;
                },

                async addRow() {
                    // Check if all required fields in insertRow are filled
                    if (!this.selectedTable || !this.selectedDb || !this.tableColumns.length) return;
                    const values = this.tableColumns.map(col => this.insertRow[col.name]);
                    if (values.some(v => v === undefined || v === null || v === "")) return;
                    this.loading = true;

                    try {
                        await this.apiCall(`/api/databases/${this.selectedDb.id}/data`, {
                            method: 'POST',
                            body: JSON.stringify({
                                table: this.selectedTable,
                                columns: this.tableColumns.map(col => col.name).join(', '),
                                values: values.map(v => typeof v === 'string' ? `'${v}'` : v).join(', ')
                            })
                        });
                        // Clear insertRow fields
                        this.insertRow = {};
                        // Reload table data
                        await this.selectTable(this.selectedTable);
                        this.setMessage('Row added successfully!', 'success');
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                    this.loading = false;
                },

                async deleteRow(selectedRow, index) {
                    if (!this.selectedDb || !this.selectedTable) return;
                    // Build condition using all columns to uniquely identify the row
                    const condition = {};
                    this.tableColumns.forEach((col, i) => {
                        condition[col.name] = Array.isArray(selectedRow) ? selectedRow[i] : selectedRow[col.name];
                    });

                    this.loading = true;
                    try {
                        await this.apiCall(`/api/databases/${this.selectedDb.id}/tables/${this.selectedTable}/data`, {
                            method: 'DELETE',
                            body: JSON.stringify({ condition })
                        });
                        // Reload table data
                        await this.selectTable(this.selectedTable);
                        this.setMessage('Row deleted successfully!', 'success');
                        this.showRowDropdown = null;
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                    this.loading = false;
                },

                // Query execution methods
                async executeQuery() {
                    if (!this.queryText.trim() || !this.selectedDb) return;

                    this.loading = true;
                    try {
                        const result = await this.apiCall(`/api/databases/${this.selectedDb.id}/query`, {
                            method: 'POST',
                            body: JSON.stringify({ sql: this.queryText })
                        });
                        console.log(result)
                        // Optionally handle query results here
                        this.setMessage('Query executed successfully!', 'success');

                        // Reload tables after creation
                        const results = await this.apiCall(`/api/databases/${this.selectedDb.id}/tables`);
                        this.tables = results.data || [];

                        // Optionally reload table data if needed
                        if (this.selectedTable) {
                            await this.selectTable(this.selectedTable);
                        }
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                    this.loading = false;
                },

                // Table management methods
                async createTable() {
                    if (!this.newTableForm.name.trim() || !this.newTableForm.columns.trim() || !this.selectedDb) return;

                    this.loading = true;
                    try {
                        await this.apiCall(`/api/databases/${this.selectedDb.id}/tables`, {
                            method: 'POST',
                            body: JSON.stringify({
                                name: this.newTableForm.name,
                                columns: this.newTableForm.columns
                            })
                        });

                        this.showTableModal = false;
                        this.resetTableForm();
                        // Reload tables after creation
                        const result = await this.apiCall(`/api/databases/${this.selectedDb.id}/tables`);
                        this.tables = result.data || [];
                        this.setMessage('Table created successfully!', 'success');
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                    this.loading = false;
                },

                async deleteTable() {
                    const tableName = this.selectedTable
                    this.loading = true;
                    try {
                        await this.apiCall(`/api/databases/${this.selectedDb.id}/tables/${tableName}`, { method: 'DELETE' });
                        // Reload tables after deletion
                        const result = await this.apiCall(`/api/databases/${this.selectedDb.id}/tables`);
                        this.tables = result.data || [];
                        if (this.selectedTable) {
                            this.selectedTable = null;
                            this.tableData = [];
                            this.tableColumns = [];
                            this.showDeleteTableModal = false
                        }
                        this.setMessage('Table deleted successfully!', 'success');
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                    this.loading = false;
                },

                // Data insertion methods
                async insertData() {
                    if (
                        !this.selectedTable.trim() ||
                        !this.insertForm.values.trim() ||
                        !this.selectedDb
                    ) {
                        console.log(this.insertForm)
                        this.setMessage('Please fill all fields before inserting data.', 'error');
                        return;
                    }

                    this.loading = true;
                    try {
                        await this.apiCall(`/api/databases/${this.selectedDb.id}/data`, {
                            method: 'POST',
                            body: JSON.stringify({
                                table: this.selectedTable ? this.selectedTable : this.insertForm.table,
                                columns: this.selectedTable ? this.tableColumns.map(col => col.name).join(", ") : this.insertForm.columns,
                                values: this.insertForm.values
                            })
                        });

                        this.showInsertModal = false;
                        this.resetInsertForm();
                        if (this.selectedTable) {
                            await this.selectTable(this.selectedTable);
                        }
                        this.setMessage('Data inserted successfully!', 'success');
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                    this.loading = false;
                },

                // Shared database methods
                async accessSharedDatabase() {
                    if (!this.sharedToken.trim()) return;

                    this.loading = true;
                    try {
                        const result = await this.apiCall(`/api/shared/${this.sharedToken}`);
                        console.log(result.data)
                        this.sharedDb = result.data.database;
                        this.selectedDb = result.data.database;
                        this.tables = [];
                        this.selectedTable = null;
                        this.tableData = [];
                        this.tableColumns = [];
                        // Load tables for shared database
                        const tablesResult = await this.apiCall(`/api/databases/${this.sharedDb.id}/tables`);
                        this.tables = tablesResult.data || [];
                        this.setMessage('Shared database accessed successfully!', 'success');
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                    this.loading = false;
                },

                // Table selection and data loading
                async selectTable(table) {
                    this.selectedTable = table;
                    this.tableData = [];
                    this.tableColumns = [];
                    this.loading = true;
                    try {
                        const result = await this.apiCall(`/api/databases/${this.selectedDb.id}/tables/${table}/data`);
                        this.tableData = result.data.values || [];
                        this.tableColumns = result.data.columns || [];
                    } catch (error) {
                        this.setMessage('Failed to load table data', 'error');
                    }
                    this.loading = false;
                },

                //update table cell
                async updateCell(index, column, newValue, oldValue) {
                    if (!this.selectedDb || !this.selectedTable) return;
                    // Find the row to update
                    const row = this.filteredTableData[index];
                    if (!row) return;

                    // Build condition (use all columns as condition for now)
                    const condition = {};
                    this.tableColumns.forEach((col, i) => {
                        // Use value from row (array or object)
                        condition[col.name] = Array.isArray(row) ? row[i] : row[col.name];
                    });

                    // Only update the changed column
                    const data = {};
                    data[column] = newValue;

                    // If oldValue is undefined or null, try to use the value from the row
                    let oldVal = oldValue;
                    if (oldVal === undefined || oldVal === null) {
                        const colIndex = this.tableColumns.findIndex(col => col.name === column);
                        oldVal = Array.isArray(row) ? row[colIndex] : row[column];
                    }

                    // If oldVal is still null/undefined, set to empty string
                    if (oldVal === undefined || oldVal === null) oldVal = '';

                    this.loading = true;
                    try {
                        await this.apiCall(`/api/databases/${this.selectedDb.id}/tables/${this.selectedTable}/data`, {
                            method: 'PUT',
                            body: JSON.stringify({
                                condition,
                                data,
                                oldValue: oldVal
                            })
                        });
                        // Reload table data
                        await this.selectTable(this.selectedTable);
                        this.setMessage('Cell updated successfully!', 'success');
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                    this.loading = false;
                },

                async addColumn(columnName, columnType) {
                    if (!this.selectedDb || !this.selectedTable) return;

                    this.loading = true;
                    try {
                        const sql = `ALTER TABLE "${this.selectedTable}" ADD COLUMN "${columnName.trim()}" ${columnType.trim()}`;
                        await this.apiCall(`/api/databases/${this.selectedDb.id}/query`, {
                            method: 'POST',
                            body: JSON.stringify({ sql })
                        });
                        await this.selectTable(this.selectedTable);
                        this.setMessage('Column added successfully!', 'success');
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                    this.loading = false;
                },

                async deleteColumn(editingCell) {
                    if (!this.selectedDb || !this.selectedTable) return;
                    const columnName = editingCell.col;
                    if (!columnName) {
                        this.setMessage('Column name is required.', 'error');
                        return;
                    }
                    this.loading = true;
                    try {
                        // Use SQL query to drop the column
                        const sql = `ALTER TABLE "${this.selectedTable}" DROP COLUMN "${columnName}"`;
                        await this.apiCall(`/api/databases/${this.selectedDb.id}/query`, {
                            method: 'POST',
                            body: JSON.stringify({ sql })
                        });
                        // Reload table data
                        await this.selectTable(this.selectedTable);
                        this.setMessage('Column deleted successfully!', 'success');
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                    this.loading = false;
                },

                async updateColumnName(editingCell) {
                    if (!this.selectedDb || !this.selectedTable) return;
                    const columnName = editingCell.col;
                    const newColumnName = editingCell.value;
                    if (!columnName || !newColumnName) {
                        this.setMessage('Old and new column are required.', 'error');
                        return;
                    }
                    this.loading = true;
                    try {
                        const sql = `ALTER TABLE "${this.selectedTable}" RENAME ${columnName.trim()} TO ${newColumnName.trim()}`;
                        await this.apiCall(`/api/databases/${this.selectedDb.id}/query`, {
                            method: 'POST',
                            body: JSON.stringify({ sql })
                        });
                        await this.selectTable(this.selectedTable);
                        this.setMessage('Column name changed successfully!', 'success');
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                    this.loading = false;
                },

                async backupDB(selectedDB) {
                    if (!selectedDB || !this.backup_filename || !this.backup_format) return;
                    this.loading = true;
                    try {
                        const response = await fetch(`/api/databases/${selectedDB.id}/backup`, {
                            method: 'POST',
                            credentials: 'include',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                filename: this.backup_filename,
                                format: this.backup_format
                            })
                        });
                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(errorText || `HTTP ${response.status}`);
                        }
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = this.backup_filename;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                        window.URL.revokeObjectURL(url);
                        this.setMessage('Backup downloaded successfully!', 'success');
                    } catch (error) {
                        this.setMessage(error.message, 'error');
                    }
                    this.loading = false;
                },

                // Filtered table data
                get filteredTableData() {
                    if (!this.filterText.trim()) return this.tableData;
                    const filter = this.filterText.toLowerCase();
                    return this.tableData.filter(row =>
                        Object.values(row).some(
                            val => val !== null && String(val).toLowerCase().includes(filter)
                        )
                    );
                },

                // Form reset methods
                resetTableForm() {
                    this.newTableForm = { name: '', columns: '' };
                },

                resetInsertForm() {
                    this.insertForm = { table: '', columns: '', values: '' };
                }
            }
        }
    </script>
</body>

</html>